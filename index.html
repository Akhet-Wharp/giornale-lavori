<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Akhet - Giornale dei lavori</title>

<!-- MSAL.js - Microsoft Authentication Library (jsDelivr CDN) -->
<script src="https://cdn.jsdelivr.net/npm/@azure/msal-browser@2.38.1/lib/msal-browser.min.js"></script>

<!-- jsPDF per export PDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<!-- Leaflet per OpenStreetMap -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
/* Nascondi barre SharePoint se presente */
#O365_NavHeader,
#SuiteNavWrapper,
#SuiteNavPlaceholder,
#DeltaPlaceHolderMain > .ms-webpart-chrome,
.sp-appBar,
.ms-siteHeader-container,
.od-TopBar,
.Files-topBar,
div[data-automationid="SiteHeader"],
.sp-HubNav,
#spPageChromeAppDiv,
#spSiteHeader,
.SPPageChrome,
/* Barra nera viewer SharePoint */
.od-ItemsScopeCommandBar,
.ms-CommandBar,
div[class*="commandBar"],
div[class*="CommandBar"],
button[data-automationid="splitbuttonprimary"],
div[role="toolbar"]:not(.login-box):not(.container),
.Files-commandBar,
div[class*="topBar"]:not(.login-box):not(.container),
/* Header della finestra viewer */
header[class*="header"]:not(.header),
.od-Files-topBar {
    display: none !important;
}

/* Forza fullscreen per il contenuto */
#contentBox,
.Canvas,
.CanvasZone,
#DeltaPlaceHolderMain {
    margin: 0 !important;
    padding: 0 !important;
}

body.ms-sp-chrome-sidebar {
    margin-left: 0 !important;
}

/* Stili app */
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:Arial,sans-serif;background:linear-gradient(135deg,#667eea,#764ba2);padding:20px;min-height:100vh}
.container{max-width:1200px;margin:0 auto;background:#fff;border-radius:15px;padding:30px;box-shadow:0 20px 60px rgba(0,0,0,0.3)}
.login-box{max-width:400px;margin:50px auto;background:#fff;padding:40px;border-radius:15px;box-shadow:0 10px 30px rgba(0,0,0,0.3);text-align:center}
.header{background:#3498db;color:#fff;padding:20px;border-radius:10px;margin-bottom:20px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap}
h1{font-size:24px}
h2{margin-bottom:20px}
h3{margin-bottom:15px}
.form-group{margin-bottom:15px}
label{display:block;font-weight:600;margin-bottom:5px;text-align:left}
input,select,textarea{width:100%;padding:10px;border:1px solid #ddd;border-radius:5px;font-size:14px}
textarea{min-height:120px;font-family:inherit}
.btn{padding:10px 20px;border:none;border-radius:5px;cursor:pointer;font-size:14px;font-weight:600;margin:5px;transition:opacity 0.3s}
.btn:hover{opacity:0.8}
.btn:disabled{opacity:0.5;cursor:not-allowed}
.btn-primary{background:#3498db;color:#fff}
.btn-secondary{background:#95a5a6;color:#fff}
.btn-success{background:#27ae60;color:#fff}
.btn-danger{background:#e74c3c;color:#fff}
.btn-warning{background:#f39c12;color:#fff}
.small-btn{padding:6px 12px;font-size:12px}
.section{display:none;padding:20px;background:#f9f9f9;border-radius:8px;margin:20px 0}
.section.active{display:block}
.nav{display:flex;gap:10px;margin-bottom:20px;flex-wrap:wrap}
.nav button{padding:12px 20px;background:#ddd;border:none;border-radius:5px;cursor:pointer;font-weight:600;transition:all 0.3s}
.nav button.active{background:#3498db;color:#fff}
.nav button:hover{background:#bbb}
.card{background:#fff;border:1px solid #ddd;padding:20px;margin:15px 0;border-radius:8px;transition:box-shadow 0.3s}
.card:hover{box-shadow:0 4px 12px rgba(0,0,0,0.1)}
.card.validated{border-left:4px solid #27ae60}
.card.pending{border-left:4px solid #f39c12}
.info{background:#e3f2fd;padding:15px;border-radius:8px;margin:15px 0}
.loading{text-align:center;padding:40px;color:#666;font-size:18px}
.loading:after{content:'';animation:dots 1.5s steps(4,end) infinite}
@keyframes dots{0%,20%{content:'.'}40%{content:'..'}60%,100%{content:'...'}}
.error{background:#ffebee;color:#c62828;padding:15px;border-radius:8px;margin:15px 0;border-left:4px solid #c62828}
.success{background:#e8f5e9;color:#2e7d32;padding:15px;border-radius:8px;margin:15px 0;border-left:4px solid #2e7d32}
#userInfo{display:flex;align-items:center;gap:10px}
.badge{background:#27ae60;color:#fff;padding:3px 10px;border-radius:10px;font-size:12px;margin-left:10px}
.badge.pending{background:#f39c12}

/* Lightbox per foto */
.lightbox{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.9);z-index:2000;align-items:center;justify-content:center}
.lightbox.active{display:flex}
.lightbox img{max-width:90%;max-height:90%;border-radius:8px}
.lightbox-close{position:absolute;top:20px;right:40px;color:#fff;font-size:40px;cursor:pointer;font-weight:bold}
.lightbox-close:hover{color:#f39c12}

/* Foto nelle card */
.foto-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:10px}
.foto-thumb{width:100%;height:80px;object-fit:cover;border-radius:5px;cursor:pointer;transition:transform 0.3s}
.foto-thumb:hover{transform:scale(1.05)}

/* Grid responsive per giornali */
.giornali-grid{display:grid;grid-template-columns:repeat(2, 1fr);gap:15px}

/* Pulsante GPS geolocalizzazione */
.gps-button {
    position: absolute;
    top: 10px;
    right: 10px;
    z-index: 1000;
    background: white;
    border: 2px solid rgba(0,0,0,0.2);
    border-radius: 5px;
    padding: 8px 12px;
    cursor: pointer;
    box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    font-size: 20px;
    transition: all 0.3s;
}
.gps-button:hover {
    background: #f0f0f0;
    transform: scale(1.05);
}
.gps-button:active {
    background: #e0e0e0;
}
.gps-button.loading {
    opacity: 0.6;
    cursor: wait;
}
.gps-button.success {
    background: #27ae60;
    color: white;
    border-color: #27ae60;
}
.gps-button.error {
    background: #e74c3c;
    color: white;
    border-color: #e74c3c;
}

/* Media query per responsive */
@media (max-width: 768px) {
    .nav{flex-direction:column}
    .header{flex-direction:column;align-items:flex-start}
    .foto-grid{grid-template-columns:repeat(2,1fr)}
    .giornali-grid{grid-template-columns:1fr !important}
}

</style>
</head>
<body>

<!-- SCHERMATA LOGIN -->
<div id="loginScreen" class="login-box">
<h2>Akhet - Giornale dei lavori</h2>
<p style="color:#666;margin-bottom:30px">Akhet srl</p>
<button class="btn btn-primary" onclick="loginMicrosoft()" style="width:100%;font-size:16px" id="btnLogin">
ğŸ” Accedi con Microsoft 365
</button>
<button class="btn btn-secondary" onclick="clearSessionAndReload()" style="width:100%;font-size:14px;margin-top:10px">
ğŸ”„ Cambia Account
</button>
<p style="margin-top:20px;font-size:12px;color:#999">
Usa il tuo account aziendale Microsoft 365
</p>
<div id="loginError" class="error" style="display:none;margin-top:20px"></div>
</div>

<!-- APPLICAZIONE PRINCIPALE -->
<div id="app" class="container" style="display:none">
<div class="header">
<h1>Akhet - Giornale dei lavori</h1>
<div id="userInfo">
<span id="userName" style="color:#fff"></span>
<button class="btn btn-secondary small-btn" onclick="logout()">Esci</button>
</div>
</div>

<div class="nav">
<button id="nav-giornali" class="active" onclick="showSection('giornali')">ğŸ“‹ Giornali</button>
<button id="nav-nuovo" onclick="showSection('nuovo')">ğŸ“ Nuovo</button>
<button id="nav-cantieri" onclick="showSection('cantieri')">ğŸ—ï¸ Cantieri</button>
<button id="nav-utenti" onclick="showSection('utenti')">ğŸ‘¥ Utenti</button>
</div>

<!-- SEZIONE: I MIEI GIORNALI -->
<div id="sec-giornali" class="section active">
<h3>ğŸ“‹ Giornali dei Lavori</h3>

<!-- FILTRI AVANZATI -->
<div style="background:#fff;padding:15px;border-radius:8px;margin-bottom:20px;border:2px solid #3498db">
<p style="color:#3498db;font-weight:600;margin-bottom:10px">ğŸ” Seleziona almeno un filtro per visualizzare i giornali</p>
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:15px">
<div>
<label style="font-size:12px;color:#666;margin-bottom:5px">ğŸ—ï¸ Cantiere</label>
<select id="filtCant" onchange="applyFilters()" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:5px">
<option value="">Seleziona...</option>
</select>
</div>
<div>
<label style="font-size:12px;color:#666;margin-bottom:5px">ğŸ“… Mese</label>
<select id="filtMese" onchange="applyFilters()" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:5px">
<option value="">Seleziona...</option>
</select>
</div>
<div>
<label style="font-size:12px;color:#666;margin-bottom:5px">ğŸ“† Giorno</label>
<input type="date" id="filtGiorno" onchange="applyFilters()" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:5px">
</div>
<div>
<label style="font-size:12px;color:#666;margin-bottom:5px">âœ… Stato</label>
<select id="filtStato" onchange="applyFilters()" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:5px">
<option value="">Seleziona...</option>
<option value="validato">Validati</option>
<option value="nonvalidato">In attesa</option>
</select>
</div>
<div style="display:flex;align-items:flex-end">
<button class="btn btn-secondary small-btn" onclick="resetFilters()" style="width:100%">ğŸ”„ Reset</button>
</div>
</div>
<!-- Pulsanti Export (solo Admin/Supervisor) -->
<div style="display:flex;flex-wrap:wrap;align-items:center;gap:10px;margin-top:10px" id="exportMensileSection">
<button class="btn btn-success" onclick="openExportMensileModal()" style="display:flex;align-items:center;gap:8px">
ğŸ“Š Export Mensile PDF
</button>
<button class="btn btn-primary" onclick="openExportGeoJSONModal()" style="display:flex;align-items:center;gap:8px">
ğŸ—ºï¸ Export GeoJSON
</button>
<p style="font-size:12px;color:#666;margin:0;flex:1">
Esporta report mensile in PDF o tutti i punti mappa in GeoJSON per un cantiere
</p>
</div>
</div>

<div id="giornaliContent">
<div class="info">ğŸ” Seleziona almeno un filtro per visualizzare i giornali</div>
</div>

</div>

<!-- SEZIONE: NUOVO GIORNALE -->
<div id="sec-nuovo" class="section">
<h3>ğŸ“ Nuovo Giornale</h3>
<div id="msgForm"></div>

<form id="formGiornale" onsubmit="event.preventDefault(); saveGiornale();">

<div class="form-group">
<label>Cantiere *</label>
<select id="fCant" required onchange="updateResponsabileEnte()">
<option value="">Seleziona cantiere...</option>
</select>
</div>

<div class="form-group">
<label>LocalitÃ  *</label>
<input type="text" id="fLoc" required placeholder="es. Poirino, Via Indipendenza 56">
<p style="font-size:12px;color:#666;margin-top:5px">ğŸ’¡ Suggerimento: posiziona il punto sulla mappa per ottenere automaticamente l'indirizzo</p>
</div>

<div class="form-group">
<label>Data *</label>
<input type="date" id="fData" required>
</div>

<div class="form-group">
<label>Condizioni Meteo *</label>
<select id="fMeteo" required>
<option value="">Seleziona...</option>
<option value="Soleggiato">â˜€ï¸ Soleggiato</option>
<option value="Parzialmente nuvoloso">â›… Parzialmente nuvoloso</option>
<option value="Nuvoloso">â˜ï¸ Nuvoloso</option>
<option value="Pioggia">ğŸŒ§ï¸ Pioggia</option>
<option value="Temporale">â›ˆï¸ Temporale</option>
<option value="Neve">â„ï¸ Neve</option>
<option value="Nebbia">ğŸŒ«ï¸ Nebbia</option>
<option value="Vento forte">ğŸ’¨ Vento forte</option>
</select>
</div>

<div class="form-group">
<label>AgibilitÃ  del Cantiere *</label>
<select id="fAgib" required>
<option value="">Seleziona...</option>
<option value="Agibile">âœ… Agibile</option>
<option value="Parzialmente agibile">âš ï¸ Parzialmente agibile</option>
<option value="Non agibile">âŒ Non agibile</option>
</select>
</div>

<div class="form-group">
<label>Archeologi</label>
<div id="archeologi"></div>
<button type="button" class="btn btn-success small-btn" onclick="addArch()">â• Aggiungi</button>
</div>

<div class="form-group">
<label>Operai</label>
<div id="operai"></div>
<button type="button" class="btn btn-success small-btn" onclick="addOp()">â• Aggiungi</button>
</div>

<div class="form-group">
<label>Responsabile Ente</label>
<input type="text" id="fRespEnte" placeholder="Seleziona prima un cantiere" readonly style="background-color: #f0f0f0; cursor: not-allowed;">
<p style="font-size:12px;color:#666;margin-top:5px">â„¹ï¸ Questo campo viene ereditato dal cantiere selezionato</p>
</div>

<div class="form-group">
<label>Archeologo sul Campo</label>
<select id="fArchCampo">
<option value="">Seleziona archeologo...</option>
</select>
</div>

<div class="form-group">
<label>Responsabile Akhet</label>
<select id="fRespAkhet">
<option value="">Seleziona...</option>
<option value="David Wicks">David Wicks</option>
<option value="Stefano Di Silvestre">Stefano Di Silvestre</option>
</select>
</div>

<div class="form-group">
<label>Lavori *</label>
<textarea id="fLav" required placeholder="Descrivi i lavori effettuati..."></textarea>
</div>

<div class="form-group">
<label>Foto (min 1, max 3) *</label>
<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:15px;margin-top:10px">
<div style="text-align:center">
<div style="border:2px dashed #ddd;border-radius:8px;padding:10px;min-height:150px;display:flex;flex-direction:column;align-items:center;justify-content:center;background:#f9f9f9">
<div id="prev1" style="display:none;margin-bottom:10px">
<img id="im1" style="max-width:100%;max-height:120px;border-radius:5px">
</div>
<input type="file" id="f1" accept="image/*" style="display:none">
<button type="button" class="btn btn-primary small-btn" onclick="pickFoto(1)" id="bf1">ğŸ“· Foto 1</button>
<button type="button" class="btn btn-danger small-btn" onclick="rmFoto(1)" id="br1" style="display:none;margin-top:5px">ğŸ—‘ï¸</button>
</div>
</div>
<div style="text-align:center">
<div style="border:2px dashed #ddd;border-radius:8px;padding:10px;min-height:150px;display:flex;flex-direction:column;align-items:center;justify-content:center;background:#f9f9f9">
<div id="prev2" style="display:none;margin-bottom:10px">
<img id="im2" style="max-width:100%;max-height:120px;border-radius:5px">
</div>
<input type="file" id="f2" accept="image/*" style="display:none">
<button type="button" class="btn btn-primary small-btn" onclick="pickFoto(2)" id="bf2">ğŸ“· Foto 2</button>
<button type="button" class="btn btn-danger small-btn" onclick="rmFoto(2)" id="br2" style="display:none;margin-top:5px">ğŸ—‘ï¸</button>
</div>
</div>
<div style="text-align:center">
<div style="border:2px dashed #ddd;border-radius:8px;padding:10px;min-height:150px;display:flex;flex-direction:column;align-items:center;justify-content:center;background:#f9f9f9">
<div id="prev3" style="display:none;margin-bottom:10px">
<img id="im3" style="max-width:100%;max-height:120px;border-radius:5px">
</div>
<input type="file" id="f3" accept="image/*" style="display:none">
<button type="button" class="btn btn-primary small-btn" onclick="pickFoto(3)" id="bf3">ğŸ“· Foto 3</button>
<button type="button" class="btn btn-danger small-btn" onclick="rmFoto(3)" id="br3" style="display:none;margin-top:5px">ğŸ—‘ï¸</button>
</div>
</div>
</div>
</div>

<!-- SEZIONE MAPPA -->
<div class="form-group" style="margin-top:30px">
<label>ğŸ“ Posizione Punto di Interesse</label>
<div style="margin-bottom:10px">
<input type="text" id="fPuntoNome" placeholder="Nome del punto (es. Saggio 1, Area A, Trincea Nord)" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:5px">
</div>
<div style="position:relative">
<div id="map" style="height:400px;border:2px solid #ddd;border-radius:8px;margin-bottom:10px"></div>
<button type="button" class="gps-button" onclick="geolocateMe()" title="Usa la mia posizione GPS">
ğŸ“
</button>
</div>
<p style="font-size:12px;color:#666;margin:0">
â„¹ï¸ Clicca sulla mappa per posizionare il punto o usa il pulsante GPS ğŸ“ per la tua posizione attuale.
<span id="mapCoords" style="font-weight:bold;color:#2c3e50"></span>
</p>
</div>

<button type="submit" class="btn btn-primary" id="btnSave">ğŸ’¾ Salva Giornale</button>
<button type="button" class="btn btn-secondary" onclick="resetFormG()">ğŸ”„ Cancella</button>

</form>
</div>

<!-- SEZIONE: CANTIERI -->
<div id="sec-cantieri" class="section">
<h3>ğŸ—ï¸ Cantieri</h3>
<div id="cantieriContent">
<div class="loading">Caricamento cantieri</div>
</div>
</div>

<!-- SEZIONE: UTENTI -->
<div id="sec-utenti" class="section">
<h3>ğŸ‘¥ Gestione Utenti</h3>
<div class="info" style="margin-bottom:15px">
<strong>ğŸ” Il tuo ruolo:</strong> <span id="userRole">Caricamento...</span>
</div>
<div id="utentiContent">
<div class="loading">Caricamento utenti</div>
</div>
</div>

</div>

<!-- LIGHTBOX PER FOTO -->
<div id="lightbox" class="lightbox" onclick="closeLightbox()">
<span class="lightbox-close">&times;</span>
<img id="lightboxImg" src="" alt="Foto">
</div>

<!-- MODAL GESTIONE CANTIERE -->
<div id="modalCantiere" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);align-items:center;justify-content:center;z-index:2000">
<div style="background:#fff;padding:30px;border-radius:10px;max-width:500px;width:90%;max-height:90vh;overflow-y:auto">
<h3 id="modalCantiereTitolo">â• Nuovo Cantiere</h3>
<div class="form-group">
<label>Nome Cantiere *</label>
<input type="text" id="mCantNome" required placeholder="es. Scavi Poirino">
</div>
<div class="form-group">
<label>Committente *</label>
<input type="text" id="mCantComm" required placeholder="es. SMAT">
</div>
<div class="form-group">
<label>Codice Progetto *</label>
<input type="text" id="mCantProg" required placeholder="es. 6697">
</div>
<div class="form-group">
<label>Codice Commessa *</label>
<input type="text" id="mCantComessa" required placeholder="es. 204_030">
</div>
<div class="form-group">
<label>Codice Sito</label>
<input type="text" id="mCantSito" placeholder="es. POIR-001">
</div>

<div class="form-group">
<label>Responsabile Ente</label>
<input type="text" id="mCantRespEnte" placeholder="es. Dott. Mario Rossi">
</div>

<!-- SEZIONE GEOJSON -->
<div class="form-group" style="margin-top:30px">
<label>ğŸ—ºï¸ Mappa Progetto (GeoJSON)</label>

<!-- Upload GeoJSON (solo Admin/Supervisor) -->
<div id="geoJsonUploadSection">
<input type="file" id="mCantGeoJson" accept=".geojson,.json" style="display:none" onchange="loadGeoJsonFile(event)">
<button type="button" class="btn btn-success small-btn" onclick="document.getElementById('mCantGeoJson').click()" id="btnUploadGeoJson">
ğŸ“ Carica GeoJSON
</button>
<button type="button" class="btn btn-danger small-btn" onclick="removeGeoJson()" id="btnRemoveGeoJson" style="display:none;margin-left:10px">
ğŸ—‘ï¸ Rimuovi
</button>
<p style="font-size:12px;color:#666;margin-top:5px" id="geoJsonFileName"></p>
</div>

<!-- Mappa preview -->
<div id="cantiereMap" style="height:300px;border:2px solid #ddd;border-radius:8px;margin-top:10px"></div>
<p style="font-size:12px;color:#666;margin-top:5px">
â„¹ï¸ Carica un file GeoJSON per visualizzare punti, linee o poligoni del progetto
</p>
</div>

<div style="display:flex;gap:10px;margin-top:20px">
<button class="btn btn-primary" onclick="saveCantiere()" id="btnSaveCant">ğŸ’¾ Salva</button>
<button class="btn btn-secondary" onclick="closeModalCantiere()">âŒ Annulla</button>
</div>
</div>
</div>

<!-- MODAL VISUALIZZAZIONE CANTIERE (SOLA LETTURA) -->
<div id="modalViewCantiere" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);align-items:center;justify-content:center;z-index:2000">
<div style="background:#fff;padding:30px;border-radius:10px;max-width:700px;width:90%;max-height:90vh;overflow-y:auto">
<h3>ğŸ‘ï¸ Visualizzazione Cantiere</h3>

<div class="form-group">
<label>Nome Cantiere</label>
<p id="viewCantNome" style="padding:10px;background:#f5f5f5;border-radius:5px;margin:5px 0"></p>
</div>

<div class="form-group">
<label>Committente</label>
<p id="viewCantComm" style="padding:10px;background:#f5f5f5;border-radius:5px;margin:5px 0"></p>
</div>

<div style="display:grid;grid-template-columns:1fr 1fr;gap:15px">
<div class="form-group">
<label>Codice Progetto</label>
<p id="viewCantProg" style="padding:10px;background:#f5f5f5;border-radius:5px;margin:5px 0"></p>
</div>
<div class="form-group">
<label>Codice Commessa</label>
<p id="viewCantComessa" style="padding:10px;background:#f5f5f5;border-radius:5px;margin:5px 0"></p>
</div>
</div>

<div class="form-group">
<label>Codice Sito</label>
<p id="viewCantSito" style="padding:10px;background:#f5f5f5;border-radius:5px;margin:5px 0"></p>
</div>

<div class="form-group">
<label>Responsabile Ente</label>
<p id="viewCantRespEnte" style="padding:10px;background:#f5f5f5;border-radius:5px;margin:5px 0"></p>
</div>

<!-- MAPPA GEOJSON -->
<div class="form-group" style="margin-top:30px">
<label>ğŸ—ºï¸ Mappa Progetto</label>
<div id="viewCantiereMap" style="height:400px;border:2px solid #ddd;border-radius:8px;margin-top:10px"></div>
<p id="viewGeoJsonStatus" style="font-size:12px;color:#666;margin-top:5px;text-align:center"></p>
</div>

<div style="display:flex;gap:10px;margin-top:20px;justify-content:center">
<button class="btn btn-secondary" onclick="closeViewCantiere()">âœ• Chiudi</button>
</div>
</div>
</div>

<!-- MODAL EXPORT MENSILE -->
<div id="modalExportMensile" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);align-items:center;justify-content:center;z-index:2000">
<div style="background:#fff;padding:30px;border-radius:10px;max-width:500px;width:90%">
<h3>ğŸ“Š Export Mensile PDF</h3>
<p style="color:#666;margin-bottom:20px">Seleziona cantiere e mese per generare un PDF unico con tutti i giornali</p>

<div class="form-group">
<label>ğŸ—ï¸ Cantiere *</label>
<select id="expCantiere" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:5px">
<option value="">Seleziona cantiere...</option>
</select>
</div>

<div class="form-group">
<label>ğŸ“… Mese *</label>
<input type="month" id="expMese" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:5px">
</div>

<div id="expMessage" style="margin-top:15px"></div>

<div style="display:flex;gap:10px;margin-top:20px">
<button class="btn btn-success" onclick="generaExportMensile()" id="btnExportMensile">ğŸ“„ Genera PDF</button>
<button class="btn btn-secondary" onclick="closeExportMensileModal()">âœ• Annulla</button>
</div>
</div>
</div>

<!-- MODAL EXPORT GEOJSON -->
<div id="modalExportGeoJSON" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);align-items:center;justify-content:center;z-index:2000">
<div style="background:#fff;padding:30px;border-radius:10px;max-width:500px;width:90%">
<h3>ğŸ—ºï¸ Export GeoJSON Punti Mappa</h3>
<p style="color:#666;margin-bottom:20px">Seleziona un cantiere per esportare tutti i punti mappa segnati nei giornali</p>

<div class="form-group">
<label>ğŸ—ï¸ Cantiere *</label>
<select id="geoJsonCantiere" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:5px">
<option value="">Seleziona cantiere...</option>
</select>
</div>

<div id="geoJsonMessage" style="margin-top:15px"></div>

<div style="display:flex;gap:10px;margin-top:20px">
<button class="btn btn-primary" onclick="generaExportGeoJSON()" id="btnExportGeoJSON">ğŸ“¥ Scarica GeoJSON</button>
<button class="btn btn-secondary" onclick="closeExportGeoJSONModal()">âœ• Annulla</button>
</div>
</div>
</div>

<!-- MODAL GESTIONE UTENTE -->
<div id="modalUtente" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);align-items:center;justify-content:center;z-index:2000">
<div style="background:#fff;padding:30px;border-radius:10px;max-width:500px;width:90%;max-height:90vh;overflow-y:auto">
<h3 id="modalUtenteTitolo">ğŸ‘¤ Gestione Utente</h3>
<div class="form-group">
<label>Nome Utente</label>
<input type="text" id="mUserName" disabled style="background:#f5f5f5">
</div>
<div class="form-group">
<label>Email</label>
<input type="text" id="mUserEmail" disabled style="background:#f5f5f5">
</div>
<div class="form-group">
<label>Ruolo *</label>
<select id="mUserRole">
<option value="operator">Operator (Solo propri giornali)</option>
<option value="supervisor">Supervisor (Tutti i giornali + Valida)</option>
<option value="admin">Admin (Tutto)</option>
</select>
</div>
<div class="form-group">
<label>Cantieri Assegnati</label>
<div id="mUserCantieri" style="max-height:200px;overflow-y:auto;border:1px solid #ddd;padding:10px;border-radius:5px">
</div>
</div>
<div style="display:flex;gap:10px;margin-top:20px">
<button class="btn btn-primary" onclick="saveUtente()" id="btnSaveUser">ğŸ’¾ Salva</button>
<button class="btn btn-secondary" onclick="closeModalUtente()">âŒ Annulla</button>
</div>
</div>
</div>

<!-- MODAL MODIFICA GIORNALE -->
<div id="modalEditGiornale" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);align-items:center;justify-content:center;z-index:2000;overflow-y:auto;padding:20px">
<div style="background:#fff;padding:30px;border-radius:10px;max-width:800px;width:95%;max-height:90vh;overflow-y:auto;margin:auto">
<h3>âœï¸ Modifica Giornale</h3>

<div class="form-group">
<label>Cantiere *</label>
<select id="editCantiere" required disabled style="background:#f5f5f5;cursor:not-allowed">
<option value="">Seleziona cantiere...</option>
</select>
<p style="font-size:12px;color:#f39c12;margin-top:5px">âš ï¸ Il cantiere non puÃ² essere modificato dopo la creazione</p>
</div>

<div class="form-group">
<label>LocalitÃ  *</label>
<input type="text" id="editLocalita" required placeholder="es. Poirino, Via Indipendenza 56">
<p style="font-size:12px;color:#666;margin-top:5px">ğŸ’¡ Suggerimento: posiziona il punto sulla mappa per ottenere automaticamente l'indirizzo</p>
</div>

<div class="form-group">
<label>Data *</label>
<input type="date" id="editData" required>
</div>

<div class="form-group">
<label>Condizioni Meteo *</label>
<select id="editMeteo" required>
<option value="">Seleziona...</option>
<option value="Soleggiato">â˜€ï¸ Soleggiato</option>
<option value="Parzialmente nuvoloso">â›… Parzialmente nuvoloso</option>
<option value="Nuvoloso">â˜ï¸ Nuvoloso</option>
<option value="Pioggia">ğŸŒ§ï¸ Pioggia</option>
<option value="Temporale">â›ˆï¸ Temporale</option>
<option value="Neve">â„ï¸ Neve</option>
<option value="Nebbia">ğŸŒ«ï¸ Nebbia</option>
<option value="Vento forte">ğŸ’¨ Vento forte</option>
</select>
</div>

<div class="form-group">
<label>AgibilitÃ  del Cantiere *</label>
<select id="editAgibilita" required>
<option value="">Seleziona...</option>
<option value="Agibile">âœ… Agibile</option>
<option value="Parzialmente agibile">âš ï¸ Parzialmente agibile</option>
<option value="Non agibile">âŒ Non agibile</option>
</select>
</div>

<div class="form-group">
<label>Archeologi</label>
<div id="editArcheologi"></div>
<button type="button" class="btn btn-success small-btn" onclick="addEditArch()">â• Aggiungi</button>
</div>

<div class="form-group">
<label>Operai</label>
<div id="editOperai"></div>
<button type="button" class="btn btn-success small-btn" onclick="addEditOp()">â• Aggiungi</button>
</div>

<div class="form-group">
<label>Responsabile Ente</label>
<input type="text" id="editRespEnte" placeholder="Ereditato dal cantiere" readonly style="background-color: #f0f0f0; cursor: not-allowed;">
<p style="font-size:12px;color:#666;margin-top:5px">â„¹ï¸ Questo campo viene ereditato dal cantiere</p>
</div>

<div class="form-group">
<label>Archeologo sul Campo</label>
<select id="editArchCampo">
<option value="">Seleziona archeologo...</option>
</select>
</div>

<div class="form-group">
<label>Responsabile Akhet</label>
<select id="editRespAkhet">
<option value="">Seleziona...</option>
<option value="David Wicks">David Wicks</option>
<option value="Stefano Di Silvestre">Stefano Di Silvestre</option>
</select>
</div>

<div class="form-group">
<label>Lavori *</label>
<textarea id="editLavori" rows="6" required placeholder="Descrivi i lavori effettuati..."></textarea>
</div>

<div class="form-group">
<label>ğŸ“¸ Foto (max 3)</label>
<div id="editFotoContainer">
<!-- Le foto verranno caricate qui dinamicamente -->
</div>
<button type="button" class="btn btn-success small-btn" onclick="addEditFoto()" id="btnAddEditFoto" style="margin-top:10px">â• Aggiungi Foto</button>
</div>

<!-- SEZIONE MAPPA MODIFICA -->
<div class="form-group" style="margin-top:30px">
<label>ğŸ“ Posizione Punto di Interesse</label>
<div style="margin-bottom:10px">
<input type="text" id="editPuntoNome" placeholder="Nome del punto (es. Saggio 1, Area A, Trincea Nord)" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:5px">
</div>
<div style="position:relative">
<div id="editMap" style="height:400px;border:2px solid #ddd;border-radius:8px;margin-bottom:10px"></div>
<button type="button" class="gps-button" onclick="geolocateEditMap()" title="Usa la mia posizione GPS">
ğŸ“
</button>
</div>
<p style="font-size:12px;color:#666;margin:0">
â„¹ï¸ Clicca sulla mappa per posizionare/modificare il punto o usa il pulsante GPS ğŸ“ per la tua posizione attuale.
<span id="editMapCoords" style="font-weight:bold;color:#2c3e50"></span>
</p>
</div>

<div style="display:flex;gap:10px;margin-top:20px">
<button class="btn btn-primary" onclick="saveEditGiornale()" id="btnSaveEdit">ğŸ’¾ Salva Modifiche</button>
<button class="btn btn-secondary" onclick="closeEditGiornale()">âŒ Annulla</button>
</div>
</div>
</div>

<script>
// ========================================
// RIMUOVI UI SHAREPOINT (se presente)
// ========================================
(function() {
    // Nascondi elementi SharePoint al caricamento
    const hideSharePointUI = () => {
        const selectors = [
            '#O365_NavHeader',
            '#SuiteNavWrapper',
            '#SuiteNavPlaceholder',
            '#DeltaPlaceHolderMain > .ms-webpart-chrome',
            '.sp-appBar',
            '.ms-siteHeader-container',
            '.od-TopBar',
            '.Files-topBar',
            'div[data-automationid="SiteHeader"]',
            '.sp-HubNav',
            '#spPageChromeAppDiv',
            '#spSiteHeader',
            '.SPPageChrome',
            // Barra nera del viewer
            '.od-ItemsScopeCommandBar',
            '.ms-CommandBar',
            'div[class*="commandBar"]',
            'div[class*="CommandBar"]',
            'button[data-automationid="splitbuttonprimary"]',
            '.Files-commandBar',
            '.od-Files-topBar'
        ];
        
        selectors.forEach(selector => {
            const elements = document.querySelectorAll(selector);
            elements.forEach(el => {
                // Non nascondere se contiene l'app
                if (el && !el.querySelector('.login-box') && !el.querySelector('.container') && !el.querySelector('#loginScreen') && !el.querySelector('#app')) {
                    el.style.display = 'none';
                }
            });
        });
        
        // Rimuovi margini body SharePoint
        document.body.style.marginLeft = '0';
        document.body.style.marginTop = '0';
        document.body.style.paddingTop = '0';
    };
    
    // Esegui immediatamente e dopo il caricamento
    hideSharePointUI();
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', hideSharePointUI);
    }
    window.addEventListener('load', hideSharePointUI);
    
    // Controlla periodicamente per nuovi elementi SharePoint (alcuni vengono caricati dinamicamente)
    setInterval(hideSharePointUI, 1000);
})();

// ========================================
// REDIRECT AUTOMATICO 127.0.0.1 â†’ localhost
// ========================================
if (window.location.hostname === '127.0.0.1') {
    const newUrl = window.location.href.replace('127.0.0.1', 'localhost');
    console.log('ğŸ”„ Redirect automatico a localhost...');
    window.location.replace(newUrl);
}

// ========================================
// CONFIGURAZIONE
// ========================================

const msalConfig = {
    auth: {
        clientId: "1f1379c3-6946-4ef1-8977-35d32435d409",
        authority: "https://login.microsoftonline.com/a1b7202e-cd9a-4043-98bf-ec0055b06878",
        redirectUri: window.location.origin
    },
    cache: {
        cacheLocation: "sessionStorage",
        storeAuthStateInCookie: false
    }
};

const loginRequest = {
    scopes: ["Sites.ReadWrite.All", "User.Read", "Files.ReadWrite.All"]
};

const sharePointSiteUrl = "https://akhet.sharepoint.com/sites/Akhet-Giornaledeilavori";

// Inizializza MSAL
const msalInstance = new msal.PublicClientApplication(msalConfig);

// Variabili globali
let currentUser = null;
let accessToken = null;
let siteId = null;
let cantieriListId = null;
let giornaliListId = null;
let cantieriData = [];
let giornaliData = [];
let cantiereLookupFieldName = null; // Nome interno del campo Lookup

// Variabili form
let archIdx = 0;
let opIdx = 0;
let foto = [null, null, null];

// Variabili mappa
let map = null;
let marker = null;
let puntoCoords = null; // { lat, lng }
let editMap = null;
let editMarker = null;
let editPuntoCoords = null; // { lat, lng }
let cantiereMap = null;
let cantiereGeoJsonLayer = null;
let cantiereGeoJsonData = null; // Dati GeoJSON caricati
let viewCantiereMap = null;
let viewCantiereGeoJsonLayer = null;

// Variabili filtri
let filteredGiornali = [];
let currentFilters = { cantiere: '', mese: '', giorno: '', stato: '' };
let filtersActive = false; // Traccia se almeno un filtro Ã¨ attivo
let lastActiveTab = 'giornali'; // Traccia l'ultimo tab attivo per resettare i filtri

// Cache foto
let fotoCache = {};

// Gestione modali
let editingCantiereId = null;
let editingGiornaleId = null;

// Gestione utenti e ruoli
let currentUserRole = 'operator'; // Default
let utentiData = [];
let editingUserId = null;
let utentiListId = null;

// Gestione archeologi/operai nel modal edit
let editArcheologi = [];
let editOperai = [];

// Gestione foto nel modal edit
let editFotoEsistenti = []; // Foto giÃ  su SharePoint { name, url }
let editFotoNuove = []; // File nuovi da uploadare
let editFotoEliminate = []; // Nomi file da eliminare

// ========================================
// FUNZIONE HELPER: CANTIERI ASSEGNATI
// ========================================

// Restituisce i cantieri assegnati all'utente corrente
function getCantieriAssegnati() {
    // Admin e Supervisor vedono tutti i cantieri
    if (currentUserRole === 'admin' || currentUserRole === 'supervisor') {
        return cantieriData;
    }
    
    // Operator: filtra in base ai cantieri assegnati
    const userEmail = currentUser.username || currentUser.email;
    
    console.log('ğŸ” DEBUG getCantieriAssegnati:');
    console.log('  userEmail:', userEmail);
    console.log('  utentiData.length:', utentiData.length);
    console.log('  utentiData:', utentiData);
    
    const utenteCorrente = utentiData.find(u => {
        console.log(`  Confronto: "${u.email.toLowerCase()}" === "${userEmail.toLowerCase()}"`, u.email.toLowerCase() === userEmail.toLowerCase());
        return u.email.toLowerCase() === userEmail.toLowerCase();
    });
    
    console.log('  utenteCorrente trovato:', utenteCorrente);
    
    if (!utenteCorrente) {
        console.log(`âš ï¸ Utente ${userEmail} non trovato in utentiData`);
        return [];
    }
    
    if (!utenteCorrente.cantieriAssegnati) {
        console.log(`âš ï¸ Nessun cantiere assegnato a ${userEmail}`);
        return [];
    }
    
    console.log('  cantieriAssegnati (raw):', utenteCorrente.cantieriAssegnati);
    
    // Estrai gli ID dei cantieri assegnati
    const cantieriIds = utenteCorrente.cantieriAssegnati
        .split(',')
        .map(id => id.trim())
        .filter(id => id);
    
    console.log('  cantieriIds array:', cantieriIds);
    
    // Filtra i cantieri
    const cantieriAssegnati = cantieriData.filter(c => {
        const match = cantieriIds.includes(String(c.id));
        console.log(`  Cantiere ${c.id} (${c.title}): ${match ? 'âœ… INCLUSO' : 'âŒ ESCLUSO'}`);
        return match;
    });
    
    console.log(`ğŸ” Operator ${userEmail}: ${cantieriAssegnati.length}/${cantieriData.length} cantieri assegnati`);
    
    return cantieriAssegnati;
}

// ========================================
// AUTENTICAZIONE
// ========================================

async function loginMicrosoft() {
    const btnLogin = document.getElementById('btnLogin');
    const loginError = document.getElementById('loginError');
    
    try {
        btnLogin.disabled = true;
        btnLogin.textContent = 'â³ Connessione in corso...';
        loginError.style.display = 'none';
        
        // Login popup
        const loginResponse = await msalInstance.loginPopup(loginRequest);
        
        currentUser = loginResponse.account;
        
        // Ottieni token
        const tokenResponse = await msalInstance.acquireTokenSilent({
            scopes: loginRequest.scopes,
            account: currentUser
        });
        
        accessToken = tokenResponse.accessToken;
        
        // Inizializza app
        await initializeApp();
        
    } catch (error) {
        console.error("Errore nel login:", error);
        loginError.textContent = `Errore: ${error.message}. Verifica di aver configurato correttamente Azure AD.`;
        loginError.style.display = 'block';
        btnLogin.disabled = false;
        btnLogin.textContent = 'ğŸ” Accedi con Microsoft 365';
    }
}

function logout() {
    // Pulisci sessionStorage
    sessionStorage.clear();
    
    // Logout da MSAL
    msalInstance.logoutPopup({
        postLogoutRedirectUri: window.location.origin
    }).catch(err => {
        console.error('Errore logout:', err);
        // Forza ricarica pagina anche se logout fallisce
        window.location.reload();
    });
}

function clearSessionAndReload() {
    // Pulisci tutto
    sessionStorage.clear();
    localStorage.clear();
    
    // Logout silenzioso da MSAL
    const accounts = msalInstance.getAllAccounts();
    if (accounts.length > 0) {
        msalInstance.logoutPopup({
            account: accounts[0],
            postLogoutRedirectUri: window.location.origin
        }).catch(() => {
            // Se fallisce, ricarica comunque
            window.location.reload();
        });
    } else {
        window.location.reload();
    }
}

// ========================================
// INIZIALIZZAZIONE APP
// ========================================

async function initializeApp() {
    try {
        // Nascondi login, mostra app
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('app').style.display = 'block';
        
        // Mostra info utente
        document.getElementById('userName').textContent = currentUser.name || currentUser.username;
        
        // Ottieni Site ID
        await getSiteId();
        
        // Ottieni List IDs
        await getListIds();
        
        // Ottieni lista Utenti e rileva ruolo
        await getUserListId();
        await loadCurrentUserRole();
        
        // IMPORTANTE: Carica utenti PRIMA dei cantieri
        // Gli Operator hanno bisogno di sapere quali cantieri sono assegnati
        await loadUtenti();
        
        // Carica dati iniziali
        await loadCantieri();
        
        // Inizializza form con cantieri
        popCant();
        
        // Carica giornali (con filtro per ruolo)
        await loadGiornali();
        
        // Carica foto
        await loadAllFoto();
        
        // Popola filtri
        populateFilters();
        
        showMessage('Benvenuto! Connesso a SharePoint.', 'success');
        
    } catch (error) {
        console.error("Errore nell'inizializzazione:", error);
        showMessage(`Errore: ${error.message}`, 'error');
    }
}

// ========================================
// SHAREPOINT API - HELPER FUNCTIONS
// ========================================

async function getSiteId() {
    const url = new URL(sharePointSiteUrl);
    const hostname = url.hostname;
    const sitePath = url.pathname;
    
    const response = await fetch(
        `https://graph.microsoft.com/v1.0/sites/${hostname}:${sitePath}`,
        {
            headers: { 'Authorization': `Bearer ${accessToken}` }
        }
    );
    
    if (!response.ok) {
        if (response.status === 403) {
            throw new Error(`âŒ Accesso negato al sito SharePoint!\n\n` +
                `Possibili cause:\n` +
                `1. L'utente ${currentUser.username} non ha accesso al sito\n` +
                `2. L'app Azure non ha i permessi corretti\n` +
                `3. Il sito "${sharePointSiteUrl}" non esiste o l'URL Ã¨ errato\n\n` +
                `Verifica con l'amministratore SharePoint.`);
        }
        throw new Error(`Impossibile accedere al sito SharePoint. Codice: ${response.status}`);
    }
    
    const data = await response.json();
    siteId = data.id;
    console.log("Site ID ottenuto:", siteId);
}

async function getListIds() {
    // Ottieni ID lista Cantieri
    const cantieriResponse = await fetch(
        `https://graph.microsoft.com/v1.0/sites/${siteId}/lists?$filter=displayName eq 'Cantieri'`,
        {
            headers: { 'Authorization': `Bearer ${accessToken}` }
        }
    );
    
    const cantieriData = await cantieriResponse.json();
    if (cantieriData.value.length === 0) {
        throw new Error("Lista 'Cantieri' non trovata in SharePoint");
    }
    cantieriListId = cantieriData.value[0].id;
    
    // Ottieni ID lista Giornali
    const giornaliResponse = await fetch(
        `https://graph.microsoft.com/v1.0/sites/${siteId}/lists?$filter=displayName eq 'Giornali'`,
        {
            headers: { 'Authorization': `Bearer ${accessToken}` }
        }
    );
    
    const giornaliDataResp = await giornaliResponse.json();
    if (giornaliDataResp.value.length === 0) {
        throw new Error("Lista 'Giornali' non trovata in SharePoint");
    }
    giornaliListId = giornaliDataResp.value[0].id;
    
    console.log("List IDs ottenuti - Cantieri:", cantieriListId, "Giornali:", giornaliListId);
    
    // Ottieni il nome del campo Lookup del cantiere
    try {
        const columnsResponse = await fetch(
            `https://graph.microsoft.com/v1.0/sites/${siteId}/lists/${giornaliListId}/columns`,
            {
                headers: { 'Authorization': `Bearer ${accessToken}` }
            }
        );
        
        const columnsData = await columnsResponse.json();
        
        console.log("ğŸ” DEBUG: Tutte le colonne della lista Giornali:");
        columnsData.value.forEach(col => {
            if (col.lookup) {
                console.log(`   - Display: "${col.displayName}" | Name: "${col.name}" -> Lista ID: ${col.lookup.listId}`);
            }
        });
        
        console.log(`ğŸ” DEBUG: Cerco colonna Lookup che punta a cantieriListId: ${cantieriListId}`);
        
        // Cerca il campo Lookup che punta alla lista Cantieri
        const lookupColumn = columnsData.value.find(col => 
            col.lookup && col.lookup.listId === cantieriListId
        );
        
        if (lookupColumn) {
            // IMPORTANTE: usa displayName invece di name per il binding
            cantiereLookupFieldName = lookupColumn.displayName;
            console.log("âœ… Nome campo Lookup cantiere trovato:");
            console.log(`   - displayName: ${lookupColumn.displayName}`);
            console.log(`   - name: ${lookupColumn.name}`);
            console.log(`   - UserÃ²: ${cantiereLookupFieldName}`);
        } else {
            console.error("âŒ Campo Lookup cantiere NON TROVATO!");
            console.error("   cantieriListId cercato:", cantieriListId);
            console.error("   Tutte le colonne Lookup:", columnsData.value.filter(c => c.lookup));
            cantiereLookupFieldName = 'Cantiere'; // Fallback
            console.warn("âš ï¸ Uso 'Cantiere' come fallback");
        }
    } catch (e) {
        console.error("âŒ Errore recupero schema colonne:", e);
        cantiereLookupFieldName = 'Cantiere'; // Fallback
    }
}

// ========================================
// CARICAMENTO DATI
// ========================================

async function loadCantieri() {
    try {
        const response = await fetch(
            `https://graph.microsoft.com/v1.0/sites/${siteId}/lists/${cantieriListId}/items?$expand=fields`,
            {
                headers: { 'Authorization': `Bearer ${accessToken}` }
            }
        );
        
        if (!response.ok) {
            throw new Error(`Errore nel caricamento cantieri: ${response.status}`);
        }
        
        const data = await response.json();
        
        cantieriData = data.value.map(item => ({
            id: item.id,
            title: item.fields.Title,
            committente: item.fields.Committente || '',
            codiceProgetto: item.fields.CodProg || '',
            codiceCommessa: item.fields.CodComm || '',
            codiceSito: item.fields.CodiceSito || '',
            responsabileEnte: item.fields.ResponsabileEnte || '',
            geoJson: item.fields.GeoJson || '',
            createdBy: item.fields.Author?.LookupValue || 'Sconosciuto',
            created: item.fields.Created
        }));
        
        console.log(`Caricati ${cantieriData.length} cantieri`);
        displayCantieri();
        
    } catch (error) {
        console.error("Errore nel caricamento cantieri:", error);
        document.getElementById('cantieriContent').innerHTML = 
            `<div class="error">Errore nel caricamento cantieri: ${error.message}</div>`;
    }
}

async function loadGiornali() {
    try {
        // Nota: Author non puÃ² essere espanso in $select - prendiamo tutti i campi
        const response = await fetch(
            `https://graph.microsoft.com/v1.0/sites/${siteId}/lists/${giornaliListId}/items?$expand=fields`,
            {
                headers: { 'Authorization': `Bearer ${accessToken}` }
            }
        );
        
        if (!response.ok) {
            const errorText = await response.text();
            console.error("Errore SharePoint:", errorText);
            throw new Error(`Errore nel caricamento giornali: ${response.status}. Dettagli: ${errorText}`);
        }
        
        const data = await response.json();
        
        giornaliData = data.value.map(item => {
            // DEBUG: Log primi 2 giornali per vedere TUTTI i campi disponibili
            if (giornaliData.length < 2) {
                console.log('ğŸ“‹ Giornale completo:', item.fields);
            }
            
            // Costruisci dinamicamente il nome del campo LookupId
            const lookupIdField = `${cantiereLookupFieldName}LookupId`;
            
            return {
                id: item.id,
                title: item.fields.Title,
                codiceSito: item.fields.CodiceSito || '',
                // SharePoint usa [NomeCampo]LookupId per il campo Lookup
                cantiere: item.fields[lookupIdField] ? 
                    cantieriData.find(c => c.id == item.fields[lookupIdField])?.title || 'N/A' : 'N/A',
                cantiereId: item.fields[lookupIdField] || null,
                data: item.fields.DataGiornale,
                meteo: item.fields.CondMeteo || '',
                agibilita: item.fields.Agibilita || '',
                archeologi: parseJSON(item.fields.Archeologi),
                operai: parseJSON(item.fields.Operai),
                responsabileEnte: item.fields.ResponsabileEnte || '',
                archeologoSulCampo: item.fields.ArcheologoSulCampo || '',
                responsabileAkhet: item.fields.ResponsabileAkhet || '',
                lavori: item.fields.Lavori || '',
                puntoMappa: parseJSON(item.fields.PuntoMappa),
                validato: item.fields.Validato || false,
                author: item.fields.Author?.LookupValue || 'Sconosciuto',
                authorEmail: item.fields.AuthorEmail || '', // Campo personalizzato
                created: item.fields.Created
            };
        });
        
        // Ordina per data (piÃ¹ recente prima) - lato client
        giornaliData.sort((a, b) => {
            const dateA = new Date(a.data || a.created);
            const dateB = new Date(b.data || b.created);
            return dateB - dateA;
        });
        
        console.log(`Caricati ${giornaliData.length} giornali (totali)`);
        
        // FILTRO PER RUOLO
        if (currentUserRole === 'operator') {
            // Operator vede solo i suoi giornali
            const userEmail = (currentUser.username || currentUser.email || '').toLowerCase();
            const userName = currentUser.name || '';
            const originalCount = giornaliData.length;
            
            console.log('ğŸ” DEBUG Filtro Operator in loadGiornali:');
            console.log('  userEmail:', userEmail);
            console.log('  userName:', userName);
            console.log('  currentUser:', currentUser);
            console.log('  giornaliData PRIMA del filtro:', giornaliData.length);
            
            // Log primi 2 giornali per vedere la struttura
            if (giornaliData.length > 0) {
                console.log('  Esempio giornale[0]:', {
                    id: giornaliData[0].id,
                    author: giornaliData[0].author,
                    authorEmail: giornaliData[0].authorEmail,
                    title: giornaliData[0].title,
                    cantiereId: giornaliData[0].cantiereId
                });
            }
            
            // Ottieni i cantieri assegnati all'Operator
            const cantieriAssegnatiOperator = getCantieriAssegnati();
            const cantieriAssegnatiIds = cantieriAssegnatiOperator.map(c => String(c.id));
            console.log('  Cantieri assegnati all\'Operator:', cantieriAssegnatiIds);
            
            giornaliData = giornaliData.filter(g => {
                // Confronta con l'email dell'autore (piÃ¹ affidabile) o con il nome
                const authorEmailMatch = g.authorEmail && g.authorEmail.toLowerCase() === userEmail;
                const authorNameMatch = g.author === userName;
                const isAuthor = authorEmailMatch || authorNameMatch;
                
                // Verifica che il giornale sia di un cantiere assegnato
                const cantiereAssegnato = cantieriAssegnatiIds.includes(String(g.cantiereId));
                
                const match = isAuthor && cantiereAssegnato;
                
                console.log(`  Giornale ${g.id}: author="${g.author}", authorEmail="${g.authorEmail}", cantiereId="${g.cantiereId}", isAuthor=${isAuthor}, cantiereAssegnato=${cantiereAssegnato}, match=${match}`);
                
                return match;
            });
            
            console.log(`ğŸ‘¤ Operator: visualizzati ${giornaliData.length}/${originalCount} giornali personali`);
        } else if (currentUserRole === 'supervisor') {
            console.log(`âœ… Supervisor: visualizzati ${giornaliData.length} giornali (tutti)`);
        } else if (currentUserRole === 'admin') {
            console.log(`ğŸ‘‘ Admin: visualizzati ${giornaliData.length} giornali (tutti)`);
        }
        
        // Carica le foto per ogni giornale
        await loadAllFoto();
        
        // Inizializza filtri
        populateFilters();
        
        // NON mostrare i giornali finchÃ© non si applica un filtro
        filteredGiornali = [];
        filtersActive = false;
        
        // Mostra messaggio iniziale
        document.getElementById('giornaliContent').innerHTML = 
            '<div class="info">ğŸ” Seleziona almeno un filtro per visualizzare i giornali</div>';
        
    } catch (error) {
        console.error("Errore nel caricamento giornali:", error);
        document.getElementById('giornaliContent').innerHTML = 
            `<div class="error">Errore nel caricamento giornali: ${error.message}</div>`;
    }
}

// ========================================
// VISUALIZZAZIONE DATI
// ========================================

function displayCantieri() {
    const container = document.getElementById('cantieriContent');
    
    // Ottieni i cantieri da mostrare in base al ruolo
    const cantieriDaMostrare = getCantieriAssegnati();
    
    if (cantieriDaMostrare.length === 0) {
        const message = currentUserRole === 'operator' 
            ? 'ğŸ“‹ Nessun cantiere assegnato. Contatta un amministratore.'
            : 'ğŸ“‹ Nessun cantiere presente.';
        container.innerHTML = `
            <div class="info">${message}</div>
            ${(currentUserRole === 'admin' || currentUserRole === 'supervisor') ? '<button class="btn btn-primary" onclick="openModalCantiere()">â• Nuovo Cantiere</button>' : ''}
        `;
        return;
    }
    
    let html = '';
    // Solo Admin e Supervisor possono creare nuovi cantieri
    if (currentUserRole === 'admin' || currentUserRole === 'supervisor') {
        html = '<button class="btn btn-primary" onclick="openModalCantiere()" style="margin-bottom:15px">â• Nuovo Cantiere</button>';
    }
    html += '<div style="display:grid;gap:15px">';
    
    cantieriDaMostrare.forEach(cantiere => {
        html += `
            <div class="card">
                <h4>ğŸ—ï¸ ${cantiere.title}</h4>
                <p><strong>Committente:</strong> ${cantiere.committente}</p>
                <p><strong>Codice Progetto:</strong> ${cantiere.codiceProgetto}</p>
                <p><strong>Codice Commessa:</strong> ${cantiere.codiceCommessa}</p>
                ${cantiere.codiceSito ? `<p><strong>Codice Sito:</strong> ${cantiere.codiceSito}</p>` : ''}
                ${cantiere.responsabileEnte ? `<p><strong>Responsabile Ente:</strong> ${cantiere.responsabileEnte}</p>` : ''}
                <div style="margin-top:15px;display:flex;gap:10px;flex-wrap:wrap">
                    <button class="btn btn-primary small-btn" onclick="viewCantiere(${cantiere.id})">ğŸ‘ï¸ Visualizza</button>
                    ${(currentUserRole === 'admin' || currentUserRole === 'supervisor') ? `
                    <button class="btn btn-warning small-btn" onclick="editCantiere(${cantiere.id})">âœï¸ Modifica</button>
                    <button class="btn btn-danger small-btn" onclick="deleteCantiere(${cantiere.id})">ğŸ—‘ï¸ Elimina</button>
                    ` : ''}
                </div>
                <p style="font-size:12px;color:#666;margin-top:10px">
                    Creato da ${cantiere.createdBy} il ${formatDate(cantiere.created)}
                </p>
            </div>
        `;
    });
    
    html += '</div>';
    container.innerHTML = html;
}

function displayGiornali() {
    const container = document.getElementById('giornaliContent');
    
    // Per gli Operator, mostra sempre i loro giornali (anche senza filtri)
    if (currentUserRole === 'operator') {
        // Filtra automaticamente i giornali dell'Operator
        const userEmail = currentUser.username || currentUser.email;
        const userName = currentUser.name;
        
        console.log('ğŸ” DEBUG Operator:');
        console.log('  userEmail:', userEmail);
        console.log('  userName:', userName);
        console.log('  giornaliData totali:', giornaliData.length);
        
        const operatorGiornali = giornaliData.filter(g => {
            const match = g.authorEmail === userEmail || 
                   g.author === userName || 
                   g.author === userEmail;
            
            console.log(`  Giornale ${g.id}: author="${g.author}", authorEmail="${g.authorEmail}", match=${match}`);
            
            // Confronta con email o nome
            return match;
        });
        
        console.log('  giornali filtrati:', operatorGiornali.length);
        
        // Se ci sono filtri attivi, applicali
        if (filtersActive) {
            filteredGiornali = operatorGiornali.filter(g => {
                // Filtro cantiere
                if (currentFilters.cantiere && g.cantiereId != currentFilters.cantiere) {
                    return false;
                }
                
                // Filtro mese
                if (currentFilters.mese) {
                    const d = new Date(g.data || g.created);
                    const gMese = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
                    if (gMese !== currentFilters.mese) {
                        return false;
                    }
                }
                
                // Filtro giorno
                if (currentFilters.giorno) {
                    const d = new Date(g.data || g.created);
                    const gGiorno = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
                    if (gGiorno !== currentFilters.giorno) {
                        return false;
                    }
                }
                
                // Filtro stato
                if (currentFilters.stato === 'validato' && !g.validato) {
                    return false;
                }
                if (currentFilters.stato === 'nonvalidato' && g.validato) {
                    return false;
                }
                
                return true;
            });
        } else {
            // Nessun filtro attivo: mostra tutti i giornali dell'Operator
            filteredGiornali = operatorGiornali;
        }
    } else {
        // Admin e Supervisor: richiedono filtri
        if (!filtersActive) {
            filteredGiornali = []; // Reset importante!
            container.innerHTML = '<div class="info">ğŸ” Seleziona almeno un filtro per visualizzare i giornali</div>';
            return;
        }
    }
    
    if (filteredGiornali.length === 0) {
        const message = currentUserRole === 'operator' 
            ? 'ğŸ“‹ Non hai ancora creato giornali.' 
            : 'ğŸ“‹ Nessun giornale trovato con questi filtri.';
        container.innerHTML = `<div class="info">${message}</div>`;
        return;
    }
    
    let html = '<div class="giornali-grid" style="display:grid;grid-template-columns:repeat(2, 1fr);gap:15px">';
    
    filteredGiornali.forEach(giornale => {
        const statusBadge = giornale.validato ? 
            '<span class="badge">âœ… Validato</span>' : 
            '<span class="badge pending">â³ In attesa</span>';
        
        // Foto del giornale
        const fotoHtml = fotoCache[giornale.id] ? 
            `<div class="foto-grid">
                ${fotoCache[giornale.id].map((url, idx) => 
                    `<img src="${url}" class="foto-thumb" onclick="openLightbox('${url}')" alt="Foto ${idx + 1}">`
                ).join('')}
            </div>` : '';
        
        html += `
            <div class="card ${giornale.validato ? 'validated' : 'pending'}">
                <h4>ğŸ“ ${giornale.title} ${statusBadge}</h4>
                <p><strong>Cantiere:</strong> ${giornale.cantiere}</p>
                <p><strong>Data:</strong> ${formatDate(giornale.data)} | 
                   <strong>Meteo:</strong> ${giornale.meteo} | 
                   <strong>AgibilitÃ :</strong> ${giornale.agibilita}</p>
                ${formatPersonale(giornale.archeologi, 'Archeologi')}
                ${formatPersonale(giornale.operai, 'Operai')}
                <p style="margin-top:10px"><strong>Lavori:</strong></p>
                <p style="color:#555">${giornale.lavori.substring(0, 200)}${giornale.lavori.length > 200 ? '...' : ''}</p>
                ${fotoHtml}
                <div style="margin-top:15px;display:flex;gap:10px;flex-wrap:wrap">
                    ${(currentUserRole === 'admin' || currentUserRole === 'supervisor') && !giornale.validato ? 
                        `<button class="btn btn-success small-btn" onclick="validaGiornale(${giornale.id})">âœ… Valida</button>` : 
                        (currentUserRole === 'admin' || currentUserRole === 'supervisor') && giornale.validato ?
                        `<button class="btn btn-secondary small-btn" onclick="invalidaGiornale(${giornale.id})">â†©ï¸ Annulla Validazione</button>` : ''
                    }
                    <button class="btn btn-danger small-btn" onclick="exportPDF(${giornale.id})">ğŸ“„ PDF</button>
                    ${(currentUserRole === 'admin' || currentUserRole === 'supervisor') ? 
                        `<button class="btn btn-warning small-btn" onclick="editGiornale(${giornale.id})">âœï¸ Modifica</button>
                         <button class="btn btn-danger small-btn" onclick="deleteGiornale(${giornale.id})">ğŸ—‘ï¸ Elimina</button>` : 
                        currentUserRole === 'operator' ?
                        `<button class="btn btn-warning small-btn" onclick="editGiornale(${giornale.id})">âœï¸ Modifica</button>` : ''
                    }
                </div>
                <p style="font-size:12px;color:#666;margin-top:10px">
                    Creato da ${giornale.author} il ${formatDate(giornale.created)}
                </p>
            </div>
        `;
    });
    
    html += '</div>';
    container.innerHTML = html;
}

// ========================================
// UTILITY FUNCTIONS
// ========================================

function parseJSON(str) {
    if (!str) return [];
    try {
        return JSON.parse(str);
    } catch {
        return [];
    }
}

function formatDate(dateString) {
    if (!dateString) return 'N/A';
    const date = new Date(dateString);
    return date.toLocaleDateString('it-IT');
}

function formatPersonale(persone, tipo) {
    if (!persone || persone.length === 0) return '';
    
    const formatted = persone.map(p => {
        if (typeof p === 'string') return p;
        return `${p.nome} (${p.ore}h)`;
    }).join(', ');
    
    return `<p><strong>${tipo}:</strong> ${formatted}</p>`;
}

function showSection(name) {
    // Controllo accesso per ruoli
    if (currentUserRole === 'operator') {
        if (name === 'utenti') {
            alert('âš ï¸ Accesso negato.\n\nSolo Admin e Supervisor possono accedere a questa sezione.');
            return;
        }
    }
    
    if (currentUserRole === 'supervisor' && name === 'utenti') {
        alert('âš ï¸ Accesso negato.\n\nSolo gli Admin possono gestire gli utenti.');
        return;
    }
    
    // Se USCIAMO dal tab giornali verso un altro tab, resetta i filtri
    if (lastActiveTab === 'giornali' && name !== 'giornali') {
        console.log('ğŸ”„ Resetting filters - leaving Giornali tab to:', name);
        currentFilters = { cantiere: '', mese: '', giorno: '', stato: '' };
        filtersActive = false;
        filteredGiornali = [];
        
        // Pulisci i campi del form filtri
        const filterFields = ['filtCant', 'filtMese', 'filtGiorno', 'filtStato'];
        filterFields.forEach(fieldId => {
            const field = document.getElementById(fieldId);
            if (field) field.value = '';
        });
    }
    
    // Aggiorna l'ultimo tab attivo
    lastActiveTab = name;
    
    // Nascondi tutte le sezioni
    document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
    document.querySelectorAll('.nav button').forEach(b => b.classList.remove('active'));
    
    // Mostra sezione selezionata
    document.getElementById('sec-' + name).classList.add('active');
    document.getElementById('nav-' + name).classList.add('active');
    
    // Se Ã¨ la sezione giornali, aggiorna la visualizzazione
    if (name === 'giornali') {
        displayGiornali();
        
        // Forza il ridimensionamento della mappa dopo che la sezione Ã¨ visibile
        setTimeout(() => {
            if (map) {
                try {
                    map.invalidateSize();
                    console.log('ğŸ—ºï¸ Mappa ridimensionata');
                } catch(e) {
                    console.warn('Errore ridimensionamento mappa:', e);
                }
            }
        }, 150);
    }
}

function showMessage(message, type) {
    // Potresti implementare un sistema di notifiche toast qui
    console.log(`[${type.toUpperCase()}] ${message}`);
}

// ========================================
// INIZIALIZZAZIONE AL CARICAMENTO PAGINA
// ========================================

// Gestisci il redirect dopo il login
msalInstance.handleRedirectPromise().then(response => {
    if (response) {
        console.log("Redirect completato", response);
        currentUser = response.account;
        accessToken = response.accessToken;
        initializeApp();
    }
}).catch(error => {
    console.error("Errore nel redirect:", error);
});

// Controlla se l'utente Ã¨ giÃ  loggato
const accounts = msalInstance.getAllAccounts();
if (accounts.length > 0) {
    console.log("Utente giÃ  loggato, tentativo di silent login...");
    currentUser = accounts[0];
    
    msalInstance.acquireTokenSilent({
        scopes: loginRequest.scopes,
        account: currentUser
    }).then(response => {
        accessToken = response.accessToken;
        initializeApp();
    }).catch(error => {
        console.log("Silent login fallito, richiedere login:", error);
    });
}

console.log("âœ… App Akhet - Sessione 2 caricata");

// ============================================
// SESSIONE 2: FORM NUOVO GIORNALE
// ============================================

// Popola select cantieri
function popCant() {
    const sel = document.getElementById('fCant');
    sel.innerHTML = '<option value="">Seleziona cantiere...</option>';
    
    // Ottieni i cantieri da mostrare in base al ruolo
    const cantieriDaMostrare = getCantieriAssegnati();
    
    cantieriDaMostrare.forEach(c => {
        sel.innerHTML += `<option value="${c.id}">${c.title} - ${c.codiceCommessa}</option>`;
    });
    
    document.getElementById('fData').valueAsDate = new Date();
}

// Aggiorna automaticamente il Responsabile Ente quando si seleziona un cantiere
function updateResponsabileEnte() {
    const cantiereId = document.getElementById('fCant').value;
    const respEnteInput = document.getElementById('fRespEnte');
    
    if (cantiereId) {
        const cantiere = cantieriData.find(c => c.id == cantiereId);
        if (cantiere && cantiere.responsabileEnte) {
            respEnteInput.value = cantiere.responsabileEnte;
        } else {
            respEnteInput.value = '';
        }
    } else {
        respEnteInput.value = '';
    }
}

// Archeologi dinamici
function addArch() {
    if (archIdx >= 10) { alert('Max 10 archeologi'); return; }
    const div = document.createElement('div');
    div.id = 'ar' + archIdx;
    div.style.cssText = 'display:flex;gap:10px;margin-bottom:10px';
    div.innerHTML = `
        <select id="an${archIdx}" style="flex:2;padding:10px;border:1px solid #ddd;border-radius:5px" onchange="updateArchCampoSelect()">
            <option value="">Seleziona...</option>
            <option value="David Wicks">David Wicks</option>
            <option value="Stefano di Silvestre">Stefano di Silvestre</option>
            <option value="Federica Laurent">Federica Laurent</option>
            <option value="Giulio Punzo">Giulio Punzo</option>
        </select>
        <input type="number" id="ah${archIdx}" min="1" max="10" step="0.5" placeholder="Ore"
               style="flex:1;padding:10px;border:1px solid #ddd;border-radius:5px">
        <button type="button" class="btn btn-danger small-btn" onclick="document.getElementById('ar${archIdx}').remove(); updateArchCampoSelect()">â–</button>
    `;
    document.getElementById('archeologi').appendChild(div);
    archIdx++;
    updateArchCampoSelect();
}

// Aggiorna dropdown Archeologo sul Campo
function updateArchCampoSelect() {
    const select = document.getElementById('fArchCampo');
    const currentValue = select.value;
    
    // Ottieni lista archeologi correnti
    const archeologi = [];
    for (let i = 0; i < archIdx; i++) {
        const elem = document.getElementById('an' + i);
        if (elem && elem.value) {
            archeologi.push(elem.value);
        }
    }
    
    // Ricostruisci select
    select.innerHTML = '<option value="">Seleziona archeologo...</option>';
    archeologi.forEach(arch => {
        const opt = document.createElement('option');
        opt.value = arch;
        opt.textContent = arch;
        select.appendChild(opt);
    });
    
    // Ripristina valore se presente
    if (currentValue && archeologi.includes(currentValue)) {
        select.value = currentValue;
    }
}

// Operai dinamici
function addOp() {
    if (opIdx >= 5) { alert('Max 5 operai'); return; }
    const div = document.createElement('div');
    div.id = 'op' + opIdx;
    div.style.cssText = 'display:flex;gap:10px;margin-bottom:10px';
    div.innerHTML = `
        <select id="on${opIdx}" style="flex:2;padding:10px;border:1px solid #ddd;border-radius:5px">
            <option value="">Seleziona...</option>
            <option value="Cami Defrim">Cami Defrim</option>
            <option value="Michele Furfaro">Michele Furfaro</option>
        </select>
        <input type="number" id="oh${opIdx}" min="1" max="10" step="0.5" placeholder="Ore"
               style="flex:1;padding:10px;border:1px solid #ddd;border-radius:5px">
        <button type="button" class="btn btn-danger small-btn" onclick="document.getElementById('op${opIdx}').remove()">â–</button>
    `;
    document.getElementById('operai').appendChild(div);
    opIdx++;
}

// Gestione foto
function pickFoto(n) {
    document.getElementById('f' + n).click();
}

document.getElementById('f1').onchange = () => handleFoto(1);
document.getElementById('f2').onchange = () => handleFoto(2);
document.getElementById('f3').onchange = () => handleFoto(3);

async function handleFoto(n) {
    const file = document.getElementById('f' + n).files[0];
    if (!file) return;
    
    const btn = document.getElementById('bf' + n);
    btn.textContent = 'â³ Caricamento...';
    btn.disabled = true;
    
    try {
        const blob = await compImg(file);
        foto[n - 1] = blob;
        
        const url = URL.createObjectURL(blob);
        document.getElementById('im' + n).src = url;
        document.getElementById('prev' + n).style.display = 'block';
        btn.textContent = 'âœï¸ Cambia';
        btn.disabled = false;
        document.getElementById('br' + n).style.display = 'inline-block';
        
        console.log(`Foto ${n}: ${Math.round(blob.size / 1024)} KB`);
    } catch (e) {
        alert('Errore caricamento foto');
        btn.textContent = 'ğŸ“· Foto ' + n;
        btn.disabled = false;
    }
}

function rmFoto(n) {
    foto[n - 1] = null;
    document.getElementById('f' + n).value = '';
    document.getElementById('prev' + n).style.display = 'none';
    document.getElementById('bf' + n).textContent = 'ğŸ“· Foto ' + n;
    document.getElementById('br' + n).style.display = 'none';
}

function compImg(file) {
    return new Promise((ok, err) => {
        const r = new FileReader();
        r.onload = e => {
            const img = new Image();
            img.onload = () => {
                const c = document.createElement('canvas');
                let w = img.width, h = img.height;
                if (w > h && w > 1200) { h *= 1200 / w; w = 1200; }
                else if (h > 1200) { w *= 1200 / h; h = 1200; }
                c.width = w; c.height = h;
                c.getContext('2d').drawImage(img, 0, 0, w, h);
                c.toBlob(ok, 'image/jpeg', 0.8);
            };
            img.onerror = err;
            img.src = e.target.result;
        };
        r.onerror = err;
        r.readAsDataURL(file);
    });
}

// Raccogli archeologi
function getArch() {
    const a = [];
    for (let i = 0; i < archIdx; i++) {
        const n = document.getElementById('an' + i);
        const h = document.getElementById('ah' + i);
        if (n && n.value && h && h.value) {
            a.push({ nome: n.value, ore: parseFloat(h.value) });
        }
    }
    return a;
}

// Raccogli operai
function getOp() {
    const o = [];
    for (let i = 0; i < opIdx; i++) {
        const n = document.getElementById('on' + i);
        const h = document.getElementById('oh' + i);
        if (n && n.value && h && h.value) {
            o.push({ nome: n.value, ore: parseFloat(h.value) });
        }
    }
    return o;
}

// Reset form
// ======= GESTIONE MAPPA =======

function initMap() {
    // Inizializza mappa centrata su Italia (Valle d'Aosta)
    map = L.map('map').setView([45.7, 7.3], 10);
    
    // Aggiungi layer OpenStreetMap
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap contributors',
        maxZoom: 19
    }).addTo(map);
    
    // Click sulla mappa per posizionare marker
    map.on('click', function(e) {
        const lat = e.latlng.lat.toFixed(6);
        const lng = e.latlng.lng.toFixed(6);
        
        // Rimuovi marker precedente se esiste
        if (marker) {
            map.removeLayer(marker);
        }
        
        // Aggiungi nuovo marker
        marker = L.marker([lat, lng]).addTo(map);
        
        // Salva coordinate
        puntoCoords = { lat: parseFloat(lat), lng: parseFloat(lng) };
        
        // Mostra coordinate
        document.getElementById('mapCoords').textContent = ` (${lat}, ${lng})`;
        
        // Chiama reverse geocoding per compilare automaticamente la localitÃ 
        reverseGeocode(lat, lng, false);
    });
    
    // Fix per dimensioni mappa - ridimensiona piÃ¹ volte per sicurezza
    setTimeout(() => {
        if (map) map.invalidateSize();
    }, 100);
    setTimeout(() => {
        if (map) map.invalidateSize();
    }, 300);
    setTimeout(() => {
        if (map) map.invalidateSize();
    }, 600);
}

// Funzione di reverse geocoding - ottiene indirizzo da coordinate
async function reverseGeocode(lat, lng, isEditMode = false) {
    try {
        console.log(`ğŸŒ Reverse geocoding per: ${lat}, ${lng}`);
        
        // Chiamata API Nominatim di OpenStreetMap
        const response = await fetch(
            `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&addressdetails=1&accept-language=it`,
            {
                headers: {
                    'User-Agent': 'Akhet-GiornaleLavori/1.0' // Richiesto da Nominatim
                }
            }
        );
        
        if (!response.ok) {
            throw new Error(`Errore API: ${response.status}`);
        }
        
        const data = await response.json();
        console.log('ğŸ“ Dati indirizzo ricevuti:', data);
        
        // Estrai comune e localitÃ 
        const address = data.address || {};
        
        // Possibili campi per il comune (in ordine di prioritÃ )
        const comune = address.city || 
                      address.town || 
                      address.village || 
                      address.municipality || 
                      address.county || 
                      '';
        
        // Possibili campi per la via/localitÃ 
        const via = address.road || 
                   address.pedestrian || 
                   address.path || 
                   '';
        
        const civico = address.house_number || '';
        
        // Componi l'indirizzo finale: "Comune" o "Comune, Via" o "Comune, Via Civico"
        let localitÃ  = comune;
        
        if (via) {
            localitÃ  = `${comune}, ${via}`;
            if (civico) {
                localitÃ  = `${comune}, ${via} ${civico}`;
            }
        }
        
        if (localitÃ ) {
            // Aggiorna il campo localitÃ 
            const locField = isEditMode ? document.getElementById('editLocalita') : document.getElementById('fLoc');
            if (locField) {
                locField.value = localitÃ ;
                console.log(`âœ… LocalitÃ  compilata: ${localitÃ }`);
                
                // Feedback visivo temporaneo
                locField.style.backgroundColor = '#d4edda';
                setTimeout(() => {
                    locField.style.backgroundColor = '';
                }, 1500);
            }
        } else {
            console.warn('âš ï¸ Indirizzo non trovato per queste coordinate');
        }
        
    } catch (error) {
        console.error('âŒ Errore reverse geocoding:', error);
        // Non mostriamo errore all'utente per non essere invasivi
        // L'utente puÃ² sempre compilare manualmente
    }
}

function resetMap() {
    if (marker) {
        map.removeLayer(marker);
        marker = null;
    }
    puntoCoords = null;
    document.getElementById('fPuntoNome').value = '';
    document.getElementById('mapCoords').textContent = '';
}

// Funzione di geolocalizzazione per la mappa principale
function geolocateMe() {
    // Trova il pulsante GPS
    const gpsButtons = document.querySelectorAll('.gps-button');
    const gpsButton = gpsButtons[0]; // Primo pulsante (mappa creazione)
    
    if (!navigator.geolocation) {
        alert('âš ï¸ La geolocalizzazione non Ã¨ supportata dal tuo browser');
        return;
    }
    
    // Stato loading
    gpsButton.classList.add('loading');
    gpsButton.textContent = 'â³';
    
    navigator.geolocation.getCurrentPosition(
        // Successo
        function(position) {
            const lat = position.coords.latitude.toFixed(6);
            const lng = position.coords.longitude.toFixed(6);
            
            console.log('ğŸ“ Posizione rilevata:', lat, lng);
            
            // Rimuovi marker precedente se esiste
            if (marker) {
                map.removeLayer(marker);
            }
            
            // Aggiungi nuovo marker
            marker = L.marker([lat, lng]).addTo(map);
            
            // Centra la mappa sulla posizione
            map.setView([lat, lng], 16);
            
            // Salva coordinate
            puntoCoords = { lat: parseFloat(lat), lng: parseFloat(lng) };
            
            // Mostra coordinate
            document.getElementById('mapCoords').textContent = ` (${lat}, ${lng})`;
            
            // Chiama reverse geocoding per compilare automaticamente la localitÃ 
            reverseGeocode(lat, lng, false);
            
            // Stato successo
            gpsButton.classList.remove('loading');
            gpsButton.classList.add('success');
            gpsButton.textContent = 'âœ“';
            
            // Ripristina dopo 2 secondi
            setTimeout(() => {
                gpsButton.classList.remove('success');
                gpsButton.textContent = 'ğŸ“';
            }, 2000);
        },
        // Errore
        function(error) {
            console.error('âŒ Errore geolocalizzazione:', error);
            
            let errorMessage = '';
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    errorMessage = 'Permesso negato. Abilita la geolocalizzazione nelle impostazioni del browser.';
                    break;
                case error.POSITION_UNAVAILABLE:
                    errorMessage = 'Posizione non disponibile. Verifica la connessione GPS.';
                    break;
                case error.TIMEOUT:
                    errorMessage = 'Timeout nella richiesta della posizione.';
                    break;
                default:
                    errorMessage = 'Errore sconosciuto nella geolocalizzazione.';
            }
            
            alert('âŒ ' + errorMessage);
            
            // Stato errore
            gpsButton.classList.remove('loading');
            gpsButton.classList.add('error');
            gpsButton.textContent = 'âœ•';
            
            // Ripristina dopo 2 secondi
            setTimeout(() => {
                gpsButton.classList.remove('error');
                gpsButton.textContent = 'ğŸ“';
            }, 2000);
        },
        // Opzioni
        {
            enableHighAccuracy: true,  // Usa GPS ad alta precisione se disponibile
            timeout: 10000,            // Timeout di 10 secondi
            maximumAge: 0              // Non usare posizioni in cache
        }
    );
}

// ======= GESTIONE MAPPA MODIFICA =======

function initEditMap() {
    // Inizializza mappa modifica centrata su Italia (Valle d'Aosta)
    editMap = L.map('editMap').setView([45.7, 7.3], 10);
    
    // Aggiungi layer OpenStreetMap
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap contributors',
        maxZoom: 19
    }).addTo(editMap);
    
    // Click sulla mappa per posizionare marker
    editMap.on('click', function(e) {
        const lat = e.latlng.lat.toFixed(6);
        const lng = e.latlng.lng.toFixed(6);
        
        // Rimuovi marker precedente se esiste
        if (editMarker) {
            editMap.removeLayer(editMarker);
        }
        
        // Aggiungi nuovo marker
        editMarker = L.marker([lat, lng]).addTo(editMap);
        
        // Salva coordinate
        editPuntoCoords = { lat: parseFloat(lat), lng: parseFloat(lng) };
        
        // Mostra coordinate
        document.getElementById('editMapCoords').textContent = ` (${lat}, ${lng})`;
        
        // Chiama reverse geocoding per compilare automaticamente la localitÃ 
        reverseGeocode(lat, lng, true);
    });
    
    // Fix per dimensioni mappa
    setTimeout(() => editMap.invalidateSize(), 100);
}

function setEditMapPoint(puntoData) {
    if (!editMap) return;
    
    if (puntoData && puntoData.lat && puntoData.lng) {
        // Posiziona marker esistente
        const lat = puntoData.lat;
        const lng = puntoData.lng;
        
        // Rimuovi marker precedente
        if (editMarker) {
            editMap.removeLayer(editMarker);
        }
        
        // Aggiungi marker
        editMarker = L.marker([lat, lng]).addTo(editMap);
        
        // Centra mappa sul punto
        editMap.setView([lat, lng], 15);
        
        // Salva coordinate
        editPuntoCoords = { lat, lng };
        
        // Mostra coordinate
        document.getElementById('editMapCoords').textContent = ` (${lat.toFixed(6)}, ${lng.toFixed(6)})`;
        
        // Popola nome
        document.getElementById('editPuntoNome').value = puntoData.nome || '';
    } else {
        // Reset
        if (editMarker) {
            editMap.removeLayer(editMarker);
            editMarker = null;
        }
        editPuntoCoords = null;
        document.getElementById('editPuntoNome').value = '';
        document.getElementById('editMapCoords').textContent = '';
    }
}

// Funzione di geolocalizzazione per la mappa di modifica
function geolocateEditMap() {
    // Trova il pulsante GPS della mappa di modifica
    const gpsButtons = document.querySelectorAll('.gps-button');
    const gpsButton = gpsButtons[1]; // Secondo pulsante (mappa modifica)
    
    if (!navigator.geolocation) {
        alert('âš ï¸ La geolocalizzazione non Ã¨ supportata dal tuo browser');
        return;
    }
    
    // Stato loading
    gpsButton.classList.add('loading');
    gpsButton.textContent = 'â³';
    
    navigator.geolocation.getCurrentPosition(
        // Successo
        function(position) {
            const lat = position.coords.latitude.toFixed(6);
            const lng = position.coords.longitude.toFixed(6);
            
            console.log('ğŸ“ Posizione rilevata (modifica):', lat, lng);
            
            // Rimuovi marker precedente se esiste
            if (editMarker) {
                editMap.removeLayer(editMarker);
            }
            
            // Aggiungi nuovo marker
            editMarker = L.marker([lat, lng]).addTo(editMap);
            
            // Centra la mappa sulla posizione
            editMap.setView([lat, lng], 16);
            
            // Salva coordinate
            editPuntoCoords = { lat: parseFloat(lat), lng: parseFloat(lng) };
            
            // Mostra coordinate
            document.getElementById('editMapCoords').textContent = ` (${lat}, ${lng})`;
            
            // Chiama reverse geocoding per compilare automaticamente la localitÃ 
            reverseGeocode(lat, lng, true);
            
            // Stato successo
            gpsButton.classList.remove('loading');
            gpsButton.classList.add('success');
            gpsButton.textContent = 'âœ“';
            
            // Ripristina dopo 2 secondi
            setTimeout(() => {
                gpsButton.classList.remove('success');
                gpsButton.textContent = 'ğŸ“';
            }, 2000);
        },
        // Errore
        function(error) {
            console.error('âŒ Errore geolocalizzazione (modifica):', error);
            
            let errorMessage = '';
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    errorMessage = 'Permesso negato. Abilita la geolocalizzazione nelle impostazioni del browser.';
                    break;
                case error.POSITION_UNAVAILABLE:
                    errorMessage = 'Posizione non disponibile. Verifica la connessione GPS.';
                    break;
                case error.TIMEOUT:
                    errorMessage = 'Timeout nella richiesta della posizione.';
                    break;
                default:
                    errorMessage = 'Errore sconosciuto nella geolocalizzazione.';
            }
            
            alert('âŒ ' + errorMessage);
            
            // Stato errore
            gpsButton.classList.remove('loading');
            gpsButton.classList.add('error');
            gpsButton.textContent = 'âœ•';
            
            // Ripristina dopo 2 secondi
            setTimeout(() => {
                gpsButton.classList.remove('error');
                gpsButton.textContent = 'ğŸ“';
            }, 2000);
        },
        // Opzioni
        {
            enableHighAccuracy: true,  // Usa GPS ad alta precisione se disponibile
            timeout: 10000,            // Timeout di 10 secondi
            maximumAge: 0              // Non usare posizioni in cache
        }
    );
}

// ======= GESTIONE GEOJSON CANTIERE =======

function initCantiereMap() {
    if (!cantiereMap) {
        cantiereMap = L.map('cantiereMap').setView([45.7, 7.3], 10);
        
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap contributors',
            maxZoom: 19
        }).addTo(cantiereMap);
        
        setTimeout(() => cantiereMap.invalidateSize(), 100);
    }
}

function loadGeoJsonFile(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const geoJsonData = JSON.parse(e.target.result);
            
            // Valida GeoJSON
            if (!geoJsonData.type || (geoJsonData.type !== 'FeatureCollection' && geoJsonData.type !== 'Feature')) {
                alert('âŒ File GeoJSON non valido');
                return;
            }
            
            // Salva dati
            cantiereGeoJsonData = geoJsonData;
            
            // Mostra su mappa
            displayGeoJsonOnMap(geoJsonData);
            
            // Mostra nome file
            document.getElementById('geoJsonFileName').textContent = `âœ… File caricato: ${file.name}`;
            document.getElementById('btnRemoveGeoJson').style.display = 'inline-block';
            
        } catch (err) {
            alert('âŒ Errore nel caricamento del file GeoJSON: ' + err.message);
            console.error('Errore GeoJSON:', err);
        }
    };
    reader.readAsText(file);
}

function displayGeoJsonOnMap(geoJsonData) {
    if (!cantiereMap) {
        initCantiereMap();
    }
    
    // Rimuovi layer precedente
    if (cantiereGeoJsonLayer) {
        cantiereMap.removeLayer(cantiereGeoJsonLayer);
    }
    
    // Aggiungi nuovo layer
    cantiereGeoJsonLayer = L.geoJSON(geoJsonData, {
        style: function(feature) {
            return {
                color: '#3498db',
                weight: 3,
                opacity: 0.8,
                fillColor: '#3498db',
                fillOpacity: 0.3
            };
        },
        pointToLayer: function(feature, latlng) {
            return L.circleMarker(latlng, {
                radius: 8,
                fillColor: '#e74c3c',
                color: '#c0392b',
                weight: 2,
                opacity: 1,
                fillOpacity: 0.8
            });
        },
        onEachFeature: function(feature, layer) {
            if (feature.properties) {
                let popupContent = '<div style="max-width:200px">';
                for (let key in feature.properties) {
                    popupContent += `<strong>${key}:</strong> ${feature.properties[key]}<br>`;
                }
                popupContent += '</div>';
                layer.bindPopup(popupContent);
            }
        }
    }).addTo(cantiereMap);
    
    // Centra mappa sui dati
    try {
        cantiereMap.fitBounds(cantiereGeoJsonLayer.getBounds(), { padding: [20, 20] });
    } catch(e) {
        console.warn('Impossibile centrare mappa:', e);
    }
}

function removeGeoJson() {
    if (confirm('âš ï¸ Vuoi rimuovere il file GeoJSON?')) {
        cantiereGeoJsonData = null;
        document.getElementById('mCantGeoJson').value = '';
        document.getElementById('geoJsonFileName').textContent = '';
        document.getElementById('btnRemoveGeoJson').style.display = 'none';
        
        if (cantiereGeoJsonLayer && cantiereMap) {
            cantiereMap.removeLayer(cantiereGeoJsonLayer);
            cantiereGeoJsonLayer = null;
            cantiereMap.setView([45.7, 7.3], 10);
        }
    }
}

function resetFormG() {
    document.getElementById('formGiornale').reset();
    document.getElementById('archeologi').innerHTML = '';
    document.getElementById('operai').innerHTML = '';
    archIdx = 0; opIdx = 0;
    for (let i = 1; i <= 3; i++) rmFoto(i);
    document.getElementById('msgForm').innerHTML = '';
    resetMap();
}

// Salva giornale
async function saveGiornale() {
    const msg = document.getElementById('msgForm');
    const btn = document.getElementById('btnSave');
    
    try {
        // Validazione
        const cid = document.getElementById('fCant').value;
        const loc = document.getElementById('fLoc').value;
        const data = document.getElementById('fData').value;
        const meteo = document.getElementById('fMeteo').value;
        const agib = document.getElementById('fAgib').value;
        const lav = document.getElementById('fLav').value;
        
        // Trova il cantiere selezionato per prendere il codice sito
        const cantiereSelezionato = cantieriData.find(c => c.id == cid);
        const codiceSito = cantiereSelezionato?.codiceSito || '';
        
        if (!cid || !loc || !data || !meteo || !agib || !lav) {
            msg.innerHTML = '<div class="error">âš ï¸ Compila tutti i campi obbligatori</div>';
            return;
        }
        
        const fotoList = foto.filter(f => f !== null);
        if (fotoList.length === 0) {
            msg.innerHTML = '<div class="error">âš ï¸ Carica almeno 1 foto</div>';
            return;
        }
        
        btn.disabled = true;
        btn.textContent = 'â³ Salvataggio...';
        msg.innerHTML = '<div class="info">ğŸ“¤ Salvataggio su SharePoint...</div>';
        
        const arch = getArch();
        const op = getOp();
        
        // Prendi ResponsabileEnte dal cantiere selezionato, non dal form
        const respEnte = cantiereSelezionato?.responsabileEnte || '';
        
        const archCampo = document.getElementById('fArchCampo').value;
        const respAkhet = document.getElementById('fRespAkhet').value;
        
        // Leggi dati punto mappa
        const puntoNome = document.getElementById('fPuntoNome').value.trim();
        const puntoData = puntoCoords ? {
            nome: puntoNome || 'Punto senza nome',
            lat: puntoCoords.lat,
            lng: puntoCoords.lng,
            cantiere: cantiereSelezionato?.title || ''
        } : null;
        
        // STEP 1: Crea giornale SENZA cantiere (SharePoint Lookup Ã¨ problematico in POST)
        const body = {
            fields: {
                Title: loc,
                CodiceSito: codiceSito || '',
                AuthorEmail: currentUser.username || currentUser.email || '', // Salva email autore
                // NO cantiere qui - lo aggiungiamo dopo
                DataGiornale: data,
                CondMeteo: meteo,
                Agibilita: agib,
                Archeologi: JSON.stringify(arch),
                Operai: JSON.stringify(op),
                Lavori: lav,
                Validato: false,
                PuntoMappa: puntoData ? JSON.stringify(puntoData) : '',
                // Includi sempre i campi obbligatori anche se vuoti
                ResponsabileEnte: respEnte || '',
                ArcheologoSulCampo: archCampo || '',
                ResponsabileAkhet: respAkhet || ''
            }
        };
        
        console.log('ğŸ“¦ STEP 1: Crea giornale (senza cantiere)');
        
        const res = await fetch(
            `https://graph.microsoft.com/v1.0/sites/${siteId}/lists/${giornaliListId}/items`,
            {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${accessToken}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(body)
            }
        );
        
        if (!res.ok) {
            const errText = await res.text();
            console.error('âŒ Errore creazione giornale:', errText);
            throw new Error(`Errore ${res.status}: ${errText.substring(0, 200)}`);
        }
        
        const item = await res.json();
        const gid = item.id;
        
        console.log(`âœ… Giornale ${gid} creato`);
        
        // STEP 2: Aggiungi il cantiere con PATCH
        try {
            console.log(`ğŸ“¦ STEP 2: Aggiungo cantiere ${cid} al giornale ${gid}`);
            console.log(`   - siteId: ${siteId}`);
            console.log(`   - cantieriListId: ${cantieriListId}`);
            console.log(`   - giornaliListId: ${giornaliListId}`);
            console.log(`   - Campo Lookup: ${cantiereLookupFieldName}`);
            
            if (!cantieriListId || !giornaliListId || !siteId || !cantiereLookupFieldName) {
                throw new Error('IDs delle liste o nome campo mancanti! Ricarica la pagina.');
            }
            
            // TENTATIVO 1: Usa formato LookupId (piÃ¹ semplice e spesso piÃ¹ affidabile)
            const lookupIdField = `${cantiereLookupFieldName}LookupId`;
            const bodyPatch = {};
            bodyPatch[lookupIdField] = parseInt(cid);
            
            console.log(`   - TENTATIVO 1: Campo LookupId: ${lookupIdField}`);
            console.log(`   - Valore: ${cid}`);
            console.log(`   - Body JSON:`, JSON.stringify(bodyPatch, null, 2));
            
            let resCant = await fetch(
                `https://graph.microsoft.com/v1.0/sites/${siteId}/lists/${giornaliListId}/items/${gid}/fields`,
                {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(bodyPatch)
                }
            );
            
            // Se il primo tentativo fallisce, prova con @odata.bind
            if (!resCant.ok) {
                console.warn(`âš ï¸ Tentativo 1 fallito, provo con @odata.bind...`);
                
                const bindProperty = `${cantiereLookupFieldName}@odata.bind`;
                const bindValue = `https://graph.microsoft.com/v1.0/sites/${siteId}/lists/${cantieriListId}/items/${cid}`;
                
                const bodyPatch2 = {};
                bodyPatch2[bindProperty] = bindValue;
                
                console.log(`   - TENTATIVO 2: Bind property: ${bindProperty}`);
                console.log(`   - Body JSON:`, JSON.stringify(bodyPatch2, null, 2));
                
                resCant = await fetch(
                    `https://graph.microsoft.com/v1.0/sites/${siteId}/lists/${giornaliListId}/items/${gid}/fields`,
                    {
                        method: 'PATCH',
                        headers: {
                            'Authorization': `Bearer ${accessToken}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(bodyPatch2)
                    }
                );
            }
            
            if (resCant.ok) {
                console.log(`âœ… Cantiere aggiunto al giornale ${gid}`);
            } else {
                const errText = await resCant.text();
                console.warn(`âš ï¸ Impossibile aggiungere cantiere: ${errText}`);
                // Non blocchiamo, il giornale Ã¨ comunque creato
            }
        } catch (e) {
            console.warn('âš ï¸ Errore aggiunta cantiere:', e.message);
            // Non blocchiamo, il giornale Ã¨ comunque creato
        }
        
        msg.innerHTML = '<div class="success">âœ… Giornale salvato! Upload foto...</div>';
        
        // Upload foto
        await uploadFoto(gid, fotoList);
        
        msg.innerHTML = '<div class="success">ğŸ‰ Completato!</div>';
        btn.textContent = 'ğŸ’¾ Salva Giornale';
        btn.disabled = false;
        
        setTimeout(() => {
            resetFormG();
            loadGiornali();
            showSection('giornali');
        }, 2000);
        
    } catch (e) {
        console.error(e);
        msg.innerHTML = `<div class="error">âŒ Errore: ${e.message}</div>`;
        btn.disabled = false;
        btn.textContent = 'ğŸ’¾ Salva Giornale';
    }
}

// Upload foto su SharePoint
async function uploadFoto(gid, fotoList) {
    try {
        // Ottieni tutte le raccolte documenti (drives) del sito
        const dr = await fetch(
            `https://graph.microsoft.com/v1.0/sites/${siteId}/drives`,
            { headers: { 'Authorization': `Bearer ${accessToken}` } }
        );
        const drives = await dr.json();
        
        console.log('Raccolte disponibili:', drives.value.map(d => d.name));
        
        // Cerca la raccolta "FotoGiornali"
        let targetDrive = drives.value.find(d => d.name === 'FotoGiornali');
        
        // Se non esiste, usa la raccolta "Documents" (principale)
        if (!targetDrive) {
            console.log('âš ï¸ Raccolta "FotoGiornali" non trovata, uso "Documents"');
            targetDrive = drives.value.find(d => d.name === 'Documents' || d.name === 'Documenti');
        }
        
        // Se ancora non trovata, usa la prima disponibile
        if (!targetDrive) {
            console.log('âš ï¸ Uso prima raccolta disponibile');
            targetDrive = drives.value[0];
        }
        
        console.log(`ğŸ“ Caricamento foto in: ${targetDrive.name}`);
        const driveId = targetDrive.id;
        
        // Carica ogni foto
        for (let i = 0; i < fotoList.length; i++) {
            const fname = `giornale_${gid}_foto_${i + 1}.jpg`;
            
            console.log(`ğŸ“¤ Upload ${fname}...`);
            
            const uploadRes = await fetch(
                `https://graph.microsoft.com/v1.0/sites/${siteId}/drives/${driveId}/root:/${fname}:/content`,
                {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'image/jpeg'
                    },
                    body: fotoList[i]
                }
            );
            
            if (!uploadRes.ok) {
                console.error(`âŒ Errore upload ${fname}:`, await uploadRes.text());
            } else {
                console.log(`âœ… ${fname} caricata`);
            }
        }
        
        console.log(`âœ… Tutte le ${fotoList.length} foto caricate in "${targetDrive.name}"`);
        
    } catch (e) {
        console.error('âŒ Errore upload foto:', e);
        throw e;
    }
}

// Helper: Ottieni Drive ID per le foto
async function getDriveId() {
    const dr = await fetch(
        `https://graph.microsoft.com/v1.0/sites/${siteId}/drives`,
        { headers: { 'Authorization': `Bearer ${accessToken}` } }
    );
    const drives = await dr.json();
    
    let targetDrive = drives.value.find(d => d.name === 'FotoGiornali');
    if (!targetDrive) {
        targetDrive = drives.value.find(d => d.name === 'Documents' || d.name === 'Documenti');
    }
    if (!targetDrive) {
        targetDrive = drives.value[0];
    }
    
    return targetDrive.id;
}

// Helper: Ottieni Folder ID della root del drive
async function getFotoFolderId(driveId) {
    // Ritorna 'root' per usare la root del drive
    return 'root';
}

console.log("ğŸ“‹ FunzionalitÃ :");

// ============================================
// SESSIONE 3 FASE A: FOTO E FILTRI
// ============================================

// Carica tutte le foto dei giornali
async function loadAllFoto() {
    try {
        // Ottieni il drive per le foto
        const dr = await fetch(
            `https://graph.microsoft.com/v1.0/sites/${siteId}/drives`,
            { headers: { 'Authorization': `Bearer ${accessToken}` } }
        );
        const drives = await dr.json();
        
        let targetDrive = drives.value.find(d => d.name === 'FotoGiornali');
        if (!targetDrive) {
            targetDrive = drives.value.find(d => d.name === 'Documents' || d.name === 'Documenti');
        }
        if (!targetDrive) {
            targetDrive = drives.value[0];
        }
        
        const driveId = targetDrive.id;
        console.log(`ğŸ“¸ Caricamento foto da: ${targetDrive.name}`);
        
        // Ottieni tutti i file dalla raccolta
        const filesRes = await fetch(
            `https://graph.microsoft.com/v1.0/sites/${siteId}/drives/${driveId}/root/children`,
            { headers: { 'Authorization': `Bearer ${accessToken}` } }
        );
        const files = await filesRes.json();
        
        // Raggruppa foto per giornale
        giornaliData.forEach(g => {
            const gFoto = files.value
                .filter(f => f.name.startsWith(`giornale_${g.id}_foto_`))
                .map(f => f['@microsoft.graph.downloadUrl']);
            
            if (gFoto.length > 0) {
                fotoCache[g.id] = gFoto;
            }
        });
        
        console.log(`âœ… Foto caricate per ${Object.keys(fotoCache).length} giornali`);
        
    } catch (e) {
        console.error('âŒ Errore caricamento foto:', e);
    }
}

// Popola i filtri
function populateFilters() {
    // Filtro cantieri
    const selCant = document.getElementById('filtCant');
    selCant.innerHTML = '<option value="">Seleziona...</option>';
    
    // Ottieni i cantieri assegnati
    const cantieriAssegnati = getCantieriAssegnati();
    const cantieriAssegnatiIds = cantieriAssegnati.map(c => String(c.id));
    
    // Trova i cantieri unici che hanno giornali
    const uniqueCant = [...new Set(giornaliData.map(g => g.cantiereId).filter(id => id))];
    
    uniqueCant.forEach(cid => {
        // Per Operator: mostra solo se il cantiere Ã¨ assegnato
        if (currentUserRole === 'operator' && !cantieriAssegnatiIds.includes(String(cid))) {
            return; // Skip questo cantiere
        }
        
        const c = cantieriData.find(x => x.id == cid);
        if (c) {
            selCant.innerHTML += `<option value="${c.id}">${c.title}</option>`;
        }
    });
    
    console.log(`ğŸ” Filtro cantieri popolato: ${selCant.options.length - 1} cantieri disponibili`);
    
    // Filtro mesi
    const selMese = document.getElementById('filtMese');
    selMese.innerHTML = '<option value="">Seleziona...</option>';
    const uniqueMesi = [...new Set(giornaliData.map(g => {
        const d = new Date(g.data || g.created);
        return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
    }))].sort().reverse();
    
    uniqueMesi.forEach(m => {
        const [anno, mese] = m.split('-');
        const nomiMesi = ['Gen','Feb','Mar','Apr','Mag','Giu','Lug','Ago','Set','Ott','Nov','Dic'];
        selMese.innerHTML += `<option value="${m}">${nomiMesi[parseInt(mese) - 1]} ${anno}</option>`;
    });
    
    // Campo giorno lasciato vuoto di default
    
    // Gestione visibilitÃ  Export Mensile (solo Admin/Supervisor)
    const exportMensileSection = document.getElementById('exportMensileSection');
    if (exportMensileSection) {
        if (currentUserRole === 'admin' || currentUserRole === 'supervisor') {
            exportMensileSection.style.display = 'flex';
        } else {
            exportMensileSection.style.display = 'none';
        }
    }
}

// Applica filtri
function applyFilters() {
    currentFilters.cantiere = document.getElementById('filtCant').value;
    currentFilters.mese = document.getElementById('filtMese').value;
    currentFilters.giorno = document.getElementById('filtGiorno').value;
    currentFilters.stato = document.getElementById('filtStato').value;
    
    // Verifica se almeno un filtro Ã¨ attivo
    filtersActive = !!(currentFilters.cantiere || currentFilters.mese || 
                       currentFilters.giorno || currentFilters.stato);
    
    // Se nessun filtro attivo, non mostrare nulla
    if (!filtersActive) {
        filteredGiornali = [];
        displayGiornali();
        return;
    }
    
    filteredGiornali = giornaliData.filter(g => {
        // FILTRO OPERATOR: vede solo i propri giornali
        if (currentUserRole === 'operator') {
            const userEmail = currentUser.username || currentUser.email;
            const userName = currentUser.name;
            
            // Confronta con email o nome
            if (!(g.authorEmail === userEmail || g.author === userName || g.author === userEmail)) {
                return false;
            }
        }
        
        // Filtro cantiere
        if (currentFilters.cantiere && g.cantiereId != currentFilters.cantiere) {
            return false;
        }
        
        // Filtro mese
        if (currentFilters.mese) {
            const d = new Date(g.data || g.created);
            const gMese = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
            if (gMese !== currentFilters.mese) {
                return false;
            }
        }
        
        // Filtro giorno (data esatta)
        if (currentFilters.giorno) {
            const d = new Date(g.data || g.created);
            const gGiorno = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
            if (gGiorno !== currentFilters.giorno) {
                return false;
            }
        }
        
        // Filtro stato
        if (currentFilters.stato === 'validato' && !g.validato) {
            return false;
        }
        if (currentFilters.stato === 'nonvalidato' && g.validato) {
            return false;
        }
        
        return true;
    });
    
    console.log(`ğŸ” Filtri applicati: ${filteredGiornali.length}/${giornaliData.length} giornali`);
    displayGiornali();
}

// Reset filtri
function resetFilters() {
    document.getElementById('filtCant').value = '';
    document.getElementById('filtMese').value = '';
    document.getElementById('filtGiorno').value = '';
    document.getElementById('filtStato').value = '';
    currentFilters = { cantiere: '', mese: '', giorno: '', stato: '' };
    filteredGiornali = [];
    filtersActive = false;
    displayGiornali();
}

// Lightbox foto
function openLightbox(url) {
    document.getElementById('lightboxImg').src = url;
    document.getElementById('lightbox').classList.add('active');
}

function closeLightbox() {
    document.getElementById('lightbox').classList.remove('active');
}

// ============================================
// SESSIONE 3 FASE B: VALIDAZIONE E EXPORT PDF
// ============================================

// Valida giornale
async function validaGiornale(id) {
    if (!confirm('Vuoi validare questo giornale?')) return;
    
    try {
        const response = await fetch(
            `https://graph.microsoft.com/v1.0/sites/${siteId}/lists/${giornaliListId}/items/${id}/fields`,
            {
                method: 'PATCH',
                headers: {
                    'Authorization': `Bearer ${accessToken}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ Validato: true })
            }
        );
        
        if (!response.ok) {
            throw new Error(`Errore ${response.status}`);
        }
        
        console.log(`âœ… Giornale ${id} validato`);
        
        // Aggiorna i dati locali
        const giornale = giornaliData.find(g => g.id == id);
        if (giornale) giornale.validato = true;
        
        const filtGiornale = filteredGiornali.find(g => g.id == id);
        if (filtGiornale) filtGiornale.validato = true;
        
        // Ridisegna
        displayGiornali();
        
        alert('âœ… Giornale validato con successo!');
        
    } catch (e) {
        console.error('Errore nella validazione:', e);
        alert('âŒ Errore nella validazione: ' + e.message);
    }
}

// Annulla validazione giornale
async function invalidaGiornale(id) {
    if (!confirm('Vuoi annullare la validazione di questo giornale?')) return;
    
    try {
        const response = await fetch(
            `https://graph.microsoft.com/v1.0/sites/${siteId}/lists/${giornaliListId}/items/${id}/fields`,
            {
                method: 'PATCH',
                headers: {
                    'Authorization': `Bearer ${accessToken}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ Validato: false })
            }
        );
        
        if (!response.ok) {
            throw new Error(`Errore ${response.status}`);
        }
        
        console.log(`â†©ï¸ Validazione giornale ${id} annullata`);
        
        // Aggiorna i dati locali
        const giornale = giornaliData.find(g => g.id == id);
        if (giornale) giornale.validato = false;
        
        const filtGiornale = filteredGiornali.find(g => g.id == id);
        if (filtGiornale) filtGiornale.validato = false;
        
        // Ridisegna
        displayGiornali();
        
        alert('â†©ï¸ Validazione annullata!');
        
    } catch (e) {
        console.error('Errore:', e);
        alert('âŒ Errore: ' + e.message);
    }
}

// Export PDF
async function exportPDF(id) {
    try {
        console.log(`ğŸ“„ Generazione PDF giornale ${id}...`);
        
        // Trova il giornale
        const g = giornaliData.find(x => x.id == id);
        if (!g) {
            alert('âŒ Giornale non trovato');
            return;
        }
        
        // Trova il cantiere
        const cant = cantieriData.find(c => c.id == g.cantiereId);
        
        // Crea PDF
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        const pageWidth = 210; // A4 width in mm
        const margin = 15;
        const contentWidth = pageWidth - (margin * 2);
        
        // Colori
        const borderColor = [0, 0, 0]; // Nero
        const headerBg = [240, 240, 240]; // Grigio chiaro
        
        let y = 15;
        
        // === LOGO AKHET ===
        const logoUrl = 'https://akhet.sharepoint.com/sites/Akhet-Giornaledeilavori/FotoGiornali/AK_marchio_2.png';
        
        // HEADER con riquadro separato
        const headerHeight = 20;
        doc.setDrawColor(...borderColor);
        doc.setLineWidth(0.3);
        doc.rect(margin, y, contentWidth, headerHeight);
        
        // Titolo a sinistra
        doc.setFontSize(14);
        doc.setFont(undefined, 'bold');
        doc.text('GIORNALE DEI LAVORI', margin + 3, y + 7);
        
        // Data sotto al titolo
        doc.setFontSize(10);
        doc.setFont(undefined, 'normal');
        doc.text(`Data: ${formatDate(g.data)}`, margin + 3, y + 14);
        
        // Logo Akhet in alto a destra (embedded base64)
        const logoBase64 = 'data:image/png;base64,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';
        
        // Visualizza il logo
        try {
            // Logo: 136x150px -> rapporto 0.907
            // Altezza fissa 15mm -> larghezza = 15 * 0.907 = 13.6mm
            doc.addImage(logoBase64, 'PNG', pageWidth - margin - 18, y + 2, 13.6, 15);
        } catch (e) {
            console.warn('Errore nel caricamento logo:', e);
        }
        
        y += headerHeight + 5;
        
        // === RIGA 1: COMMITTENTE | CODICE COMMESSA | CODICE PROGETTO ===
        doc.setFontSize(9);
        const col1 = margin;
        const col2 = margin + (contentWidth / 3);
        const col3 = margin + (contentWidth * 2 / 3);
        const rowHeight = 7;
        
        // Bordi prima riga
        doc.setDrawColor(...borderColor);
        doc.setLineWidth(0.3);
        doc.rect(col1, y, contentWidth, rowHeight * 2);
        doc.line(col2, y, col2, y + rowHeight * 2);
        doc.line(col3, y, col3, y + rowHeight * 2);
        doc.line(col1, y + rowHeight, col1 + contentWidth, y + rowHeight);
        
        // Header riga 1
        doc.setFillColor(...headerBg);
        doc.rect(col1, y, contentWidth / 3, rowHeight, 'F');
        doc.rect(col2, y, contentWidth / 3, rowHeight, 'F');
        doc.rect(col3, y, contentWidth / 3, rowHeight, 'F');
        
        doc.setFont(undefined, 'bold');
        doc.text('COMMITTENTE', col1 + 2, y + 5);
        doc.text('CODICE COMMESSA', col2 + 2, y + 5);
        doc.text('CODICE PROGETTO', col3 + 2, y + 5);
        
        // Contenuto riga 1
        doc.setFont(undefined, 'normal');
        doc.text(String(cant?.committente || ''), col1 + 2, y + rowHeight + 5);
        doc.text(String(cant?.codiceCommessa || ''), col2 + 2, y + rowHeight + 5);
        doc.text(String(cant?.codiceProgetto || ''), col3 + 2, y + rowHeight + 5);
        
        y += rowHeight * 2 + 3;
        
        // === RIGA 2: LOCALITÃ€ | CODICE SITO | CONDIZIONI METEO | AGIBILITÃ€ ===
        const col4Width = contentWidth / 4;
        const col4_1 = margin;
        const col4_2 = margin + col4Width;
        const col4_3 = margin + col4Width * 2;
        const col4_4 = margin + col4Width * 3;
        
        doc.rect(col4_1, y, contentWidth, rowHeight * 2);
        doc.line(col4_2, y, col4_2, y + rowHeight * 2);
        doc.line(col4_3, y, col4_3, y + rowHeight * 2);
        doc.line(col4_4, y, col4_4, y + rowHeight * 2);
        doc.line(col4_1, y + rowHeight, col4_1 + contentWidth, y + rowHeight);
        
        doc.setFillColor(...headerBg);
        doc.rect(col4_1, y, col4Width, rowHeight, 'F');
        doc.rect(col4_2, y, col4Width, rowHeight, 'F');
        doc.rect(col4_3, y, col4Width, rowHeight, 'F');
        doc.rect(col4_4, y, col4Width, rowHeight, 'F');
        
        doc.setFont(undefined, 'bold');
        doc.setFontSize(8);
        doc.text('CODICE SITO', col4_1 + 2, y + 5);
        doc.text('LOCALITÃ€', col4_2 + 2, y + 5);
        doc.text('CONDIZIONI METEO', col4_3 + 2, y + 5);
        doc.text('AGIBILITÃ€', col4_4 + 2, y + 5);
        
        doc.setFont(undefined, 'normal');
        doc.text(String(g.codiceSito || ''), col4_1 + 2, y + rowHeight + 5);
        doc.text(String(g.title || ''), col4_2 + 2, y + rowHeight + 5);
        doc.text(String(g.meteo || ''), col4_3 + 2, y + rowHeight + 5);
        doc.text(String(g.agibilita || ''), col4_4 + 2, y + rowHeight + 5);
        
        doc.setFontSize(9);
        y += rowHeight * 2 + 5;
        
        // === ELENCO PERSONALE AKHET ===
        doc.setFont(undefined, 'bold');
        doc.text('ELENCO PERSONALE AKHET', margin, y);
        y += 5;
        
        const maxRows = Math.max(
            g.archeologi ? g.archeologi.length : 0,
            g.operai ? g.operai.length : 0
        );
        const personaleHeight = rowHeight + (maxRows * 5);
        
        doc.rect(margin, y, contentWidth, personaleHeight);
        doc.line(margin + contentWidth / 2, y, margin + contentWidth / 2, y + personaleHeight);
        doc.line(margin, y + rowHeight, margin + contentWidth, y + rowHeight);
        
        doc.setFillColor(...headerBg);
        doc.rect(margin, y, contentWidth / 2, rowHeight, 'F');
        doc.rect(margin + contentWidth / 2, y, contentWidth / 2, rowHeight, 'F');
        
        const archColWidth = (contentWidth / 2) * 0.75;
        const oreColWidth = (contentWidth / 2) * 0.25;
        
        doc.line(margin + archColWidth, y, margin + archColWidth, y + personaleHeight);
        doc.line(margin + contentWidth / 2 + archColWidth, y, margin + contentWidth / 2 + archColWidth, y + personaleHeight);
        
        doc.setFont(undefined, 'bold');
        doc.text('ARCHEOLOGI', margin + 2, y + 5);
        doc.text('ORE', margin + archColWidth + 2, y + 5);
        doc.text('OPERAI', margin + contentWidth / 2 + 2, y + 5);
        doc.text('ORE', margin + contentWidth / 2 + archColWidth + 2, y + 5);
        
        doc.setFont(undefined, 'normal');
        let rowY = y + rowHeight + 4;
        
        for (let i = 0; i < maxRows; i++) {
            if (g.archeologi && i < g.archeologi.length) {
                const a = g.archeologi[i];
                const nome = typeof a === 'string' ? a : a.nome;
                const ore = typeof a === 'string' ? '' : String(a.ore);
                doc.text(nome, margin + 2, rowY);
                doc.text(ore, margin + archColWidth + 2, rowY);
            }
            
            if (g.operai && i < g.operai.length) {
                const o = g.operai[i];
                const nome = typeof o === 'string' ? o : o.nome;
                const ore = typeof o === 'string' ? '' : String(o.ore);
                doc.text(nome, margin + contentWidth / 2 + 2, rowY);
                doc.text(ore, margin + contentWidth / 2 + archColWidth + 2, rowY);
            }
            
            rowY += 5;
        }
        
        y += personaleHeight + 8;
        
        // === LAVORI EFFETTUATI ===
        doc.setFont(undefined, 'bold');
        doc.text('LAVORI EFFETTUATI', margin, y);
        y += 5;
        
        const lavoriText = g.lavori || '';
        doc.setFont(undefined, 'normal');
        doc.setFontSize(8);
        const lavoriLines = doc.splitTextToSize(lavoriText, contentWidth - 6);
        const lavoriHeight = Math.max(30, lavoriLines.length * 4.5 + 6);
        
        doc.rect(margin, y, contentWidth, lavoriHeight);
        
        let textY = y + 5;
        lavoriLines.forEach(line => {
            if (textY < y + lavoriHeight - 2) {
                doc.text(line, margin + 3, textY);
                textY += 4.5;
            }
        });
        doc.setFontSize(9);
        
        y += lavoriHeight + 8;
        
        // === IMMAGINI FOTOGRAFICHE ===
        const foto = fotoCache[g.id];
        if (foto && foto.length > 0) {
            if (y > 200) {
                doc.addPage();
                y = 15;
            }
            
            doc.setFont(undefined, 'bold');
            doc.text('FOTOGRAFIE', margin, y);
            y += 5;
            
            const fotoWidth = (contentWidth - 10) / 3;
            const fotoHeight = 35;
            
            for (let i = 0; i < Math.min(foto.length, 3); i++) {
                try {
                    const img = await loadImageAsBase64(foto[i]);
                    const x = margin + (i * (fotoWidth + 5));
                    doc.rect(x, y, fotoWidth, fotoHeight);
                    doc.addImage(img, 'JPEG', x + 1, y + 1, fotoWidth - 2, fotoHeight - 2);
                } catch (e) {
                    console.warn(`Impossibile caricare foto ${i + 1}:`, e);
                    doc.rect(margin + (i * (fotoWidth + 5)), y, fotoWidth, fotoHeight);
                }
            }
            y += fotoHeight + 8;
        }
        
        // === FIRME IN FONDO ===
        if (y > 240) {
            doc.addPage();
            y = 15;
        } else {
            y = 260;
        }
        
        const firmeColWidth = contentWidth / 3;
        
        doc.rect(margin, y, contentWidth, rowHeight * 3);
        doc.line(margin + firmeColWidth, y, margin + firmeColWidth, y + rowHeight * 3);
        doc.line(margin + firmeColWidth * 2, y, margin + firmeColWidth * 2, y + rowHeight * 3);
        doc.line(margin, y + rowHeight, margin + contentWidth, y + rowHeight);
        
        doc.setFillColor(...headerBg);
        doc.rect(margin, y, firmeColWidth, rowHeight, 'F');
        doc.rect(margin + firmeColWidth, y, firmeColWidth, rowHeight, 'F');
        doc.rect(margin + firmeColWidth * 2, y, firmeColWidth, rowHeight, 'F');
        
        doc.setFont(undefined, 'bold');
        doc.setFontSize(8);
        doc.text('Responsabile Ente', margin + 2, y + 5);
        doc.text('Archeologo sul campo', margin + firmeColWidth + 2, y + 5);
        doc.text('Responsabile AKHET', margin + firmeColWidth * 2 + 2, y + 5);
        
        doc.setFont(undefined, 'normal');
        doc.text(String(g.responsabileEnte || ''), margin + 2, y + rowHeight + 5);
        doc.text(String(g.archeologoSulCampo || ''), margin + firmeColWidth + 2, y + rowHeight + 5);
        doc.text(String(g.responsabileAkhet || ''), margin + firmeColWidth * 2 + 2, y + rowHeight + 5);
        
        // Linee per firma
        const firmaY = y + rowHeight * 2 + 5;
        doc.line(margin + 5, firmaY, margin + firmeColWidth - 5, firmaY);
        doc.line(margin + firmeColWidth + 5, firmaY, margin + firmeColWidth * 2 - 5, firmaY);
        doc.line(margin + firmeColWidth * 2 + 5, firmaY, margin + contentWidth - 5, firmaY);
        
        // === PUNTO MAPPA (se presente) ===
        if (g.puntoMappa && g.puntoMappa.lat && g.puntoMappa.lng) {
            y += rowHeight * 3 + 10;
            
            // Controlla se serve nuova pagina
            if (y > 240) {
                doc.addPage();
                y = 15;
            }
            
            doc.setFont(undefined, 'bold');
            doc.setFontSize(9);
            doc.text('ğŸ“ PUNTO DI INTERESSE', margin, y);
            y += 5;
            
            const puntoHeight = 20;
            doc.rect(margin, y, contentWidth, puntoHeight);
            doc.line(margin, y + 7, margin + contentWidth, y + 7);
            
            doc.setFillColor(...headerBg);
            doc.rect(margin, y, contentWidth, 7, 'F');
            
            doc.setFont(undefined, 'bold');
            doc.setFontSize(8);
            doc.text('NOME PUNTO', margin + 2, y + 5);
            
            doc.setFont(undefined, 'normal');
            doc.text(String(g.puntoMappa.nome || ''), margin + 2, y + 12);
            
            // Coordinate
            const coords = `Coordinate: ${g.puntoMappa.lat.toFixed(6)}, ${g.puntoMappa.lng.toFixed(6)}`;
            doc.setFontSize(7);
            doc.text(coords, margin + 2, y + 17);
            
            // Link OpenStreetMap
            const osmLink = `https://www.openstreetmap.org/?mlat=${g.puntoMappa.lat}&mlon=${g.puntoMappa.lng}&zoom=16`;
            doc.setTextColor(0, 0, 255);
            doc.textWithLink('Visualizza su OpenStreetMap', margin + 2, y + 17 + 3, { url: osmLink });
            doc.setTextColor(0, 0, 0);
        }
        
        // Salva PDF
        const codiceSitoPDF  = (cant?.codiceSito  || 'X').replace(/[^a-z0-9]/gi, '_');
        const codiceProgPDF  = (cant?.codiceProgetto || 'X').replace(/[^a-z0-9]/gi, '_');
        // Comune = prima parte della localitÃ  (prima della virgola)
        const localitaRaw    = (g.title || '').split(',')[0].trim();
        const localitaPDF    = (localitaRaw || 'X').replace(/[^a-z0-9]/gi, '_');
        const dataStrPDF     = formatDate(g.data).replace(/\//g, '-');
        const filename = `Gdl_${codiceSitoPDF}_${codiceProgPDF}_${localitaPDF}_${dataStrPDF}.pdf`;
        doc.save(filename);
        
        console.log(`âœ… PDF salvato: ${filename}`);
        
    } catch (e) {
        console.error('Errore nella generazione PDF:', e);
        alert('âŒ Errore nella generazione PDF: ' + e.message);
    }
}

// === EXPORT MENSILE PDF ===

function openExportMensileModal() {
    // Popola dropdown cantieri
    const select = document.getElementById('expCantiere');
    select.innerHTML = '<option value="">Seleziona cantiere...</option>';
    
    cantieriData.forEach(c => {
        const option = document.createElement('option');
        option.value = c.id;
        option.textContent = `${c.title} - ${c.committente}`;
        select.appendChild(option);
    });
    
    // Imposta mese corrente
    const now = new Date();
    const meseCorrente = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
    document.getElementById('expMese').value = meseCorrente;
    
    // Pulisci messaggi
    document.getElementById('expMessage').innerHTML = '';
    
    // Mostra modal
    document.getElementById('modalExportMensile').style.display = 'flex';
}

function closeExportMensileModal() {
    document.getElementById('modalExportMensile').style.display = 'none';
}

async function generaExportMensile() {
    const cantiereId = document.getElementById('expCantiere').value;
    const mese = document.getElementById('expMese').value;
    const msgDiv = document.getElementById('expMessage');
    const btn = document.getElementById('btnExportMensile');
    
    if (!cantiereId || !mese) {
        msgDiv.innerHTML = '<div class="error">âš ï¸ Seleziona cantiere e mese</div>';
        return;
    }
    
    try {
        btn.disabled = true;
        btn.textContent = 'â³ Generazione in corso...';
        msgDiv.innerHTML = '<div class="info">ğŸ“Š Raccolta giornali...</div>';
        
        // Trova il cantiere
        const cantiere = cantieriData.find(c => c.id == cantiereId);
        if (!cantiere) {
            throw new Error('Cantiere non trovato');
        }
        
        // Filtra giornali per cantiere e mese
        const [anno, meseNum] = mese.split('-');
        const giornaliMese = giornaliData.filter(g => {
            if (g.cantiereId != cantiereId) return false;
            
            const dataGiornale = new Date(g.data || g.created);
            const annoG = dataGiornale.getFullYear();
            const meseG = dataGiornale.getMonth() + 1;
            
            return annoG == anno && meseG == meseNum;
        });
        
        if (giornaliMese.length === 0) {
            msgDiv.innerHTML = '<div class="error">âš ï¸ Nessun giornale trovato per questo cantiere e mese</div>';
            btn.disabled = false;
            btn.textContent = 'ğŸ“„ Genera PDF';
            return;
        }
        
        // Ordina per data
        giornaliMese.sort((a, b) => new Date(a.data || a.created) - new Date(b.data || b.created));
        
        msgDiv.innerHTML = `<div class="info">ğŸ“„ Trovati ${giornaliMese.length} giornali. Generazione PDF...</div>`;
        
        // Genera PDF mensile
        await generaPDFMensile(cantiere, mese, giornaliMese);
        
        msgDiv.innerHTML = '<div class="success">âœ… PDF generato con successo!</div>';
        
        setTimeout(() => {
            closeExportMensileModal();
        }, 2000);
        
    } catch (e) {
        console.error('Errore export mensile:', e);
        msgDiv.innerHTML = `<div class="error">âŒ Errore: ${e.message}</div>`;
    } finally {
        btn.disabled = false;
        btn.textContent = 'ğŸ“„ Genera PDF';
    }
}

async function generaPDFMensile(cantiere, mese, giornali) {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('p', 'mm', 'a4');
    
    const [anno, meseNum] = mese.split('-');
    const nomeMese = new Date(anno, meseNum - 1).toLocaleString('it-IT', { month: 'long', year: 'numeric' });
    
    // === PAGINE GIORNALI ===
    for (let i = 0; i < giornali.length; i++) {
        const g = giornali[i];
        
        // Aggiungi pagina per ogni giornale (tranne la prima)
        if (i > 0) {
            doc.addPage();
        }
        
        // Usa la stessa grafica dell'export giornaliero
        await creaGiornalePDF(doc, g, cantiere, i + 1, giornali.length, nomeMese);
    }
    
    // Salva PDF
    const codiceSitoM  = (cantiere.codiceSito  || 'X').replace(/[^a-z0-9]/gi, '_');
    const codiceProgM  = (cantiere.codiceProgetto || 'X').replace(/[^a-z0-9]/gi, '_');
    // Comune dal primo giornale del mese (prima parte della localitÃ )
    const firstLoc     = giornali[0]?.title || '';
    const comuneRaw    = firstLoc.split(',')[0].trim();
    const comuneM      = (comuneRaw || 'X').replace(/[^a-z0-9]/gi, '_');
    const [annoM, meseNumM] = mese.split('-');
    const nomeFile = `Gdl_${codiceSitoM}_${codiceProgM}_${comuneM}_${meseNumM}_${annoM}.pdf`;
    doc.save(nomeFile);
}

async function creaGiornalePDF(doc, g, cantiere, numero, totale, nomeMese) {
    const pageWidth = 210; // A4 width in mm
    const margin = 15;
    const contentWidth = pageWidth - (margin * 2);
    const rowHeight = 8;
    
    // Colori
    const borderColor = [0, 0, 0]; // Nero
    const headerBg = [240, 240, 240]; // Grigio chiaro
    
    let y = 15;
    
    // === LOGO AKHET ===
    const logoBase64 = 'data:image/png;base64,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';
    
    // HEADER con riquadro separato
    const headerHeight = 20;
    doc.setDrawColor(...borderColor);
    doc.setLineWidth(0.3);
    doc.rect(margin, y, contentWidth, headerHeight);
    
    // Titolo a sinistra
    doc.setFontSize(14);
    doc.setFont(undefined, 'bold');
    doc.text('GIORNALE DEI LAVORI', margin + 3, y + 7);
    
    // Info sotto al titolo  
    doc.setFontSize(9);
    doc.setFont(undefined, 'normal');
    doc.text(`${nomeMese} - ${numero}/${totale}`, margin + 3, y + 13);
    
    // Logo Akhet in alto a destra
    try {
        doc.addImage(logoBase64, 'PNG', pageWidth - margin - 18, y + 2, 13.6, 15);
    } catch (e) {
        console.warn('Errore nel caricamento logo:', e);
    }
    
    y += headerHeight + 8;
    
    // === INFORMAZIONI CANTIERE E GIORNALE ===
    doc.setFontSize(9);
    const col1 = margin;
    const col2 = margin + (contentWidth / 3);
    const col3 = margin + (contentWidth * 2 / 3);
    
    // Bordi prima riga
    doc.setDrawColor(...borderColor);
    doc.setLineWidth(0.3);
    doc.rect(col1, y, contentWidth, rowHeight * 2);
    doc.line(col2, y, col2, y + rowHeight * 2);
    doc.line(col3, y, col3, y + rowHeight * 2);
    doc.line(col1, y + rowHeight, col1 + contentWidth, y + rowHeight);
    
    // Header riga 1
    doc.setFillColor(...headerBg);
    doc.rect(col1, y, contentWidth / 3, rowHeight, 'F');
    doc.rect(col2, y, contentWidth / 3, rowHeight, 'F');
    doc.rect(col3, y, contentWidth / 3, rowHeight, 'F');
    
    doc.setFont(undefined, 'bold');
    doc.text('COMMITTENTE', col1 + 2, y + 5);
    doc.text('CODICE COMMESSA', col2 + 2, y + 5);
    doc.text('CODICE PROGETTO', col3 + 2, y + 5);
    
    // Contenuto riga 1
    doc.setFont(undefined, 'normal');
    doc.text(String(cantiere?.committente || ''), col1 + 2, y + rowHeight + 5);
    doc.text(String(cantiere?.codiceCommessa || ''), col2 + 2, y + rowHeight + 5);
    doc.text(String(cantiere?.codiceProgetto || ''), col3 + 2, y + rowHeight + 5);
    
    y += rowHeight * 2 + 3;
    
    // === RIGA 2: LOCALITÃ€ | CODICE SITO | CONDIZIONI METEO | AGIBILITÃ€ ===
    const col4Width = contentWidth / 4;
    const col4_1 = margin;
    const col4_2 = margin + col4Width;
    const col4_3 = margin + col4Width * 2;
    const col4_4 = margin + col4Width * 3;
    
    doc.rect(col4_1, y, contentWidth, rowHeight * 2);
    doc.line(col4_2, y, col4_2, y + rowHeight * 2);
    doc.line(col4_3, y, col4_3, y + rowHeight * 2);
    doc.line(col4_4, y, col4_4, y + rowHeight * 2);
    doc.line(col4_1, y + rowHeight, col4_1 + contentWidth, y + rowHeight);
    
    doc.setFillColor(...headerBg);
    doc.rect(col4_1, y, col4Width, rowHeight, 'F');
    doc.rect(col4_2, y, col4Width, rowHeight, 'F');
    doc.rect(col4_3, y, col4Width, rowHeight, 'F');
    doc.rect(col4_4, y, col4Width, rowHeight, 'F');
    
    doc.setFont(undefined, 'bold');
    doc.setFontSize(8);
    doc.text('CODICE SITO', col4_1 + 2, y + 5);
    doc.text('LOCALITÃ€', col4_2 + 2, y + 5);
    doc.text('CONDIZIONI METEO', col4_3 + 2, y + 5);
    doc.text('AGIBILITÃ€', col4_4 + 2, y + 5);
    
    doc.setFont(undefined, 'normal');
    doc.text(String(cantiere?.codiceSito || ''), col4_1 + 2, y + rowHeight + 5);
    doc.text(String(g.title || ''), col4_2 + 2, y + rowHeight + 5);
    doc.text(String(g.meteo || ''), col4_3 + 2, y + rowHeight + 5);
    doc.text(String(g.agibilita || ''), col4_4 + 2, y + rowHeight + 5);
    
    doc.setFontSize(9);
    y += rowHeight * 2 + 5;
    
    // === ELENCO PERSONALE AKHET ===
    doc.setFont(undefined, 'bold');
    doc.text('ELENCO PERSONALE AKHET', margin, y);
    y += 5;
    
    const maxRows = Math.max(
        g.archeologi ? g.archeologi.length : 0,
        g.operai ? g.operai.length : 0
    );
    const personaleHeight = rowHeight + (maxRows * 5);
    
    doc.rect(margin, y, contentWidth, personaleHeight);
    doc.line(margin + contentWidth / 2, y, margin + contentWidth / 2, y + personaleHeight);
    doc.line(margin, y + rowHeight, margin + contentWidth, y + rowHeight);
    
    doc.setFillColor(...headerBg);
    doc.rect(margin, y, contentWidth / 2, rowHeight, 'F');
    doc.rect(margin + contentWidth / 2, y, contentWidth / 2, rowHeight, 'F');
    
    const archColWidth = (contentWidth / 2) * 0.75;
    const oreColWidth = (contentWidth / 2) * 0.25;
    
    doc.line(margin + archColWidth, y, margin + archColWidth, y + personaleHeight);
    doc.line(margin + contentWidth / 2 + archColWidth, y, margin + contentWidth / 2 + archColWidth, y + personaleHeight);
    
    doc.setFont(undefined, 'bold');
    doc.text('ARCHEOLOGI', margin + 2, y + 5);
    doc.text('ORE', margin + archColWidth + 2, y + 5);
    doc.text('OPERAI', margin + contentWidth / 2 + 2, y + 5);
    doc.text('ORE', margin + contentWidth / 2 + archColWidth + 2, y + 5);
    
    doc.setFont(undefined, 'normal');
    let rowY = y + rowHeight + 4;
    
    for (let i = 0; i < maxRows; i++) {
        if (g.archeologi && i < g.archeologi.length) {
            const a = g.archeologi[i];
            const nome = typeof a === 'string' ? a : a.nome;
            const ore = typeof a === 'string' ? '' : String(a.ore);
            doc.text(nome, margin + 2, rowY);
            doc.text(ore, margin + archColWidth + 2, rowY);
        }
        
        if (g.operai && i < g.operai.length) {
            const o = g.operai[i];
            const nome = typeof o === 'string' ? o : o.nome;
            const ore = typeof o === 'string' ? '' : String(o.ore);
            doc.text(nome, margin + contentWidth / 2 + 2, rowY);
            doc.text(ore, margin + contentWidth / 2 + archColWidth + 2, rowY);
        }
        
        rowY += 5;
    }
    
    y += personaleHeight + 5;
    
    // === DESCRIZIONE DELLE ATTIVITÃ€ ===
    doc.setFont(undefined, 'bold');
    doc.text('DESCRIZIONE DELLE ATTIVITÃ€', margin, y);
    y += 5;
    
    const lavoriLines = doc.splitTextToSize(g.lavori || '', contentWidth - 6);
    const lavoriHeight = Math.max(30, lavoriLines.length * 4.5 + 6);
    
    doc.rect(margin, y, contentWidth, lavoriHeight);
    
    doc.setFont(undefined, 'normal');
    doc.setFontSize(8);
    let textY = y + 5;
    lavoriLines.forEach(line => {
        if (textY < y + lavoriHeight - 2) {
            doc.text(line, margin + 3, textY);
            textY += 4.5;
        }
    });
    doc.setFontSize(9);
    
    y += lavoriHeight + 8;
    
    // === IMMAGINI FOTOGRAFICHE ===
    const foto = fotoCache[g.id];
    if (foto && foto.length > 0) {
        if (y > 200) {
            doc.addPage();
            y = 15;
        }
        
        doc.setFont(undefined, 'bold');
        doc.text('FOTOGRAFIE', margin, y);
        y += 5;
        
        const fotoWidth = (contentWidth - 10) / 3;
        const fotoHeight = 35;
        
        for (let i = 0; i < Math.min(foto.length, 3); i++) {
            try {
                const img = await loadImageAsBase64(foto[i]);
                const x = margin + (i * (fotoWidth + 5));
                doc.rect(x, y, fotoWidth, fotoHeight);
                doc.addImage(img, 'JPEG', x + 1, y + 1, fotoWidth - 2, fotoHeight - 2);
            } catch (e) {
                console.warn(`Impossibile caricare foto ${i + 1}:`, e);
                doc.rect(margin + (i * (fotoWidth + 5)), y, fotoWidth, fotoHeight);
            }
        }
        y += fotoHeight + 8;
    }
    
    // === FIRME IN FONDO ===
    if (y > 240) {
        doc.addPage();
        y = 15;
    } else {
        y = 260;
    }
    
    const firmeColWidth = contentWidth / 3;
    
    doc.rect(margin, y, contentWidth, rowHeight * 3);
    doc.line(margin + firmeColWidth, y, margin + firmeColWidth, y + rowHeight * 3);
    doc.line(margin + firmeColWidth * 2, y, margin + firmeColWidth * 2, y + rowHeight * 3);
    doc.line(margin, y + rowHeight, margin + contentWidth, y + rowHeight);
    
    doc.setFillColor(...headerBg);
    doc.rect(margin, y, contentWidth, rowHeight, 'F');
    
    doc.setFont(undefined, 'bold');
    doc.setFontSize(8);
    doc.text('ARCHEOLOGO RESPONSABILE', margin + firmeColWidth / 2, y + 5, { align: 'center' });
    doc.text('DIRETTORE LAVORI', margin + firmeColWidth + firmeColWidth / 2, y + 5, { align: 'center' });
    doc.text('SOVRINTENDENZA', margin + firmeColWidth * 2 + firmeColWidth / 2, y + 5, { align: 'center' });
    
    doc.setFont(undefined, 'normal');
    doc.setFontSize(7);
    
    // Testo nome sotto firma
    const firmeY = y + rowHeight * 2.5;
    doc.text('NOME E COGNOME', margin + firmeColWidth / 2, firmeY, { align: 'center' });
    doc.text('NOME E COGNOME', margin + firmeColWidth + firmeColWidth / 2, firmeY, { align: 'center' });
    doc.text('NOME E COGNOME', margin + firmeColWidth * 2 + firmeColWidth / 2, firmeY, { align: 'center' });
    
    // Footer con autore e data creazione
    doc.setFontSize(7);
    doc.setTextColor(150, 150, 150);
    doc.text(`Creato da ${g.author} il ${formatDate(g.created)}`, margin, 287);
    
    if (g.validato) {
        doc.setTextColor(39, 174, 96);
        doc.text('âœ“ VALIDATO', pageWidth - margin, 287, { align: 'right' });
    }
    
    doc.setTextColor(0, 0, 0);
}

// === EXPORT GEOJSON PUNTI MAPPA ===

function openExportGeoJSONModal() {
    // Popola dropdown cantieri
    const select = document.getElementById('geoJsonCantiere');
    select.innerHTML = '<option value="">Seleziona cantiere...</option>';
    
    cantieriData.forEach(c => {
        const option = document.createElement('option');
        option.value = c.id;
        option.textContent = `${c.title} - ${c.committente}`;
        select.appendChild(option);
    });
    
    // Pulisci messaggi
    document.getElementById('geoJsonMessage').innerHTML = '';
    
    // Mostra modal
    document.getElementById('modalExportGeoJSON').style.display = 'flex';
}

function closeExportGeoJSONModal() {
    document.getElementById('modalExportGeoJSON').style.display = 'none';
}

function generaExportGeoJSON() {
    const cantiereId = document.getElementById('geoJsonCantiere').value;
    const msgDiv = document.getElementById('geoJsonMessage');
    const btn = document.getElementById('btnExportGeoJSON');
    
    if (!cantiereId) {
        msgDiv.innerHTML = '<div class="error">âš ï¸ Seleziona un cantiere</div>';
        return;
    }
    
    try {
        btn.disabled = true;
        btn.textContent = 'â³ Generazione in corso...';
        msgDiv.innerHTML = '<div class="info">ğŸ—ºï¸ Raccolta punti mappa...</div>';
        
        // Trova il cantiere
        const cantiere = cantieriData.find(c => c.id == cantiereId);
        if (!cantiere) {
            throw new Error('Cantiere non trovato');
        }
        
        // Filtra giornali per cantiere e raccogli punti mappa
        const giornaliCantiere = giornaliData.filter(g => g.cantiereId == cantiereId);
        
        // Raccogli tutti i punti mappa
        const punti = [];
        giornaliCantiere.forEach(g => {
            if (g.puntoMappa && g.puntoMappa.lat && g.puntoMappa.lng) {
                punti.push({
                    giornale: g.title,
                    data: formatDate(g.data || g.created),
                    nome: g.puntoMappa.nome || 'Punto senza nome',
                    lat: g.puntoMappa.lat,
                    lng: g.puntoMappa.lng,
                    author: g.author,
                    validato: g.validato
                });
            }
        });
        
        if (punti.length === 0) {
            msgDiv.innerHTML = '<div class="error">âš ï¸ Nessun punto mappa trovato per questo cantiere</div>';
            btn.disabled = false;
            btn.textContent = 'ğŸ“¥ Scarica GeoJSON';
            return;
        }
        
        // Crea GeoJSON
        const geoJson = {
            type: "FeatureCollection",
            features: punti.map((p, idx) => ({
                type: "Feature",
                id: idx + 1,
                geometry: {
                    type: "Point",
                    coordinates: [p.lng, p.lat] // GeoJSON usa [lng, lat]
                },
                properties: {
                    nome: p.nome,
                    giornale: p.giornale,
                    data: p.data,
                    cantiere: cantiere.title,
                    committente: cantiere.committente,
                    author: p.author,
                    validato: p.validato ? 'SÃ¬' : 'No'
                }
            }))
        };
        
        // Scarica file
        const blob = new Blob([JSON.stringify(geoJson, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `PuntiMappa_${cantiere.title.replace(/[^a-z0-9]/gi, '_')}_${new Date().toISOString().split('T')[0]}.geojson`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        msgDiv.innerHTML = `<div class="success">âœ… GeoJSON generato con successo! ${punti.length} punti esportati</div>`;
        
        setTimeout(() => {
            closeExportGeoJSONModal();
        }, 2000);
        
    } catch (e) {
        console.error('Errore export GeoJSON:', e);
        msgDiv.innerHTML = `<div class="error">âŒ Errore: ${e.message}</div>`;
    } finally {
        btn.disabled = false;
        btn.textContent = 'ğŸ“¥ Scarica GeoJSON';
    }
}

// Carica immagine come base64
function loadImageAsBase64(url) {
    return new Promise((resolve, reject) => {
        const img = new Image();
        img.crossOrigin = 'Anonymous';
        img.onload = () => {
            const canvas = document.createElement('canvas');
            canvas.width = img.width;
            canvas.height = img.height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0);
            resolve(canvas.toDataURL('image/jpeg'));
        };
        img.onerror = reject;
        img.src = url;
    });
}

console.log("ğŸ“‹ FunzionalitÃ :");
console.log("  - Login Microsoft 365");
console.log("  - Visualizza cantieri/giornali");
console.log("  - Crea giornali");
console.log("  - Upload foto");
console.log("  - â­ Visualizza foto nei giornali");
console.log("  - â­ Filtri avanzati (cantiere, mese, giorno, stato)");
console.log("  - â­ Lightbox per foto");
console.log("  - â­ Nessun giornale mostrato finchÃ© non si applica un filtro");
console.log("  - â­ Validazione giornali");
console.log("  - â­ Export PDF professionale");
console.log("âœ… FASE B COMPLETATA!");

// ============================================
// SESSIONE 3 FASE C: MODIFICA/ELIMINA/CANTIERI
// ============================================

// === GESTIONE GIORNALI ===

// Modifica giornale
// Modifica giornale
async function editGiornale(id) {
    const g = giornaliData.find(x => x.id == id);
    if (!g) {
        alert('âŒ Giornale non trovato');
        return;
    }
    
    editingGiornaleId = id;
    
    // Reset arrays
    editArcheologi = g.archeologi ? [...g.archeologi] : [];
    editOperai = g.operai ? [...g.operai] : [];
    editFotoEsistenti = [];
    editFotoNuove = [];
    editFotoEliminate = [];
    
    // Popola il form
    document.getElementById('editLocalita').value = g.title || '';
    
    // Converti data da ISO a YYYY-MM-DD
    if (g.data) {
        const dataObj = new Date(g.data);
        const yyyy = dataObj.getFullYear();
        const mm = String(dataObj.getMonth() + 1).padStart(2, '0');
        const dd = String(dataObj.getDate()).padStart(2, '0');
        document.getElementById('editData').value = `${yyyy}-${mm}-${dd}`;
    } else {
        document.getElementById('editData').value = '';
    }
    
    document.getElementById('editMeteo').value = g.meteo || '';
    document.getElementById('editAgibilita').value = g.agibilita || '';
    document.getElementById('editLavori').value = g.lavori || '';
    
    // Popola ResponsabileEnte dal cantiere (non dal giornale)
    const cantiere = cantieriData.find(c => c.id == g.cantiereId);
    document.getElementById('editRespEnte').value = cantiere?.responsabileEnte || '';
    
    document.getElementById('editRespAkhet').value = g.responsabileAkhet || '';
    
    console.log('ğŸ“ Campi caricati per modifica:');
    console.log('  - Data originale:', g.data);
    console.log('  - Data convertita:', document.getElementById('editData').value);
    console.log('  - RespEnte (dal cantiere):', cantiere?.responsabileEnte);
    console.log('  - ArchCampo:', g.archeologoSulCampo);
    console.log('  - RespAkhet:', g.responsabileAkhet);
    
    // Popola select cantiere
    const selectCant = document.getElementById('editCantiere');
    selectCant.innerHTML = '<option value="">Seleziona cantiere...</option>';
    cantieriData.forEach(cant => {
        const opt = document.createElement('option');
        opt.value = cant.id;
        opt.textContent = cant.title;
        if (cant.id == g.cantiereId) opt.selected = true;
        selectCant.appendChild(opt);
    });
    
    // Visualizza archeologi e operai
    renderEditArch();
    renderEditOp();
    
    // Popola archeologo sul campo (dopo aver renderizzato gli archeologi)
    setTimeout(() => {
        document.getElementById('editArchCampo').value = g.archeologoSulCampo || '';
    }, 100);
    
    // Carica foto esistenti
    await loadEditFoto(g.id);
    renderEditFoto();
    
    // Inizializza mappa modifica (se non giÃ  inizializzata)
    if (!editMap) {
        setTimeout(() => {
            try {
                initEditMap();
                setEditMapPoint(g.puntoMappa);
            } catch(e) {
                console.warn('Errore inizializzazione mappa modifica:', e);
            }
        }, 100);
    } else {
        // Mappa giÃ  inizializzata, aggiorna solo il punto
        setTimeout(() => {
            editMap.invalidateSize();
            setEditMapPoint(g.puntoMappa);
        }, 100);
    }
    
    // Mostra modal
    document.getElementById('modalEditGiornale').style.display = 'flex';
}

// Carica foto esistenti per il giornale
async function loadEditFoto(giornaleId) {
    try {
        // Uso la cache foto giÃ  caricata all'inizio
        const foto = fotoCache[giornaleId] || [];
        
        console.log(`ğŸ“¸ Trovate ${foto.length} foto in cache per giornale ${giornaleId}`);
        
        if (foto.length === 0) {
            editFotoEsistenti = [];
            return;
        }
        
        // Converto gli URL in oggetti con nome fittizio
        editFotoEsistenti = foto.map((url, idx) => ({
            name: `giornale_${giornaleId}_${idx + 1}.jpg`,
            url: url,
            id: null // Non abbiamo l'ID, ma possiamo ricavarlo al momento dell'eliminazione
        }));
        
        console.log(`ğŸ“¸ Caricate ${editFotoEsistenti.length} foto esistenti per giornale ${giornaleId}`);
        
    } catch (e) {
        console.error('Errore nel caricamento foto:', e);
        editFotoEsistenti = [];
    }
}

// Renderizza foto nel modal edit
function renderEditFoto() {
    const container = document.getElementById('editFotoContainer');
    const totaleFoto = editFotoEsistenti.length + editFotoNuove.length;
    
    let html = '<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:15px;margin-top:10px">';
    
    // Foto esistenti
    editFotoEsistenti.forEach((foto, idx) => {
        html += `
            <div style="text-align:center">
                <div style="border:2px solid #ddd;border-radius:8px;padding:10px;min-height:150px;display:flex;flex-direction:column;align-items:center;justify-content:center;background:#f9f9f9">
                    <img src="${foto.url}" style="max-width:100%;max-height:120px;border-radius:5px;cursor:pointer;margin-bottom:10px" onclick="openLightbox('${foto.url}')">
                    <button type="button" class="btn btn-danger small-btn" onclick="removeEditFotoEsistente(${idx})">ğŸ—‘ï¸ Elimina</button>
                </div>
            </div>
        `;
    });
    
    // Foto nuove
    editFotoNuove.forEach((foto, idx) => {
        html += `
            <div style="text-align:center">
                <div style="border:2px dashed #4CAF50;border-radius:8px;padding:10px;min-height:150px;display:flex;flex-direction:column;align-items:center;justify-content:center;background:#f1f8f4">
                    <img src="${foto.preview}" style="max-width:100%;max-height:120px;border-radius:5px;margin-bottom:10px">
                    <p style="font-size:12px;color:#4CAF50;margin:5px 0">ğŸ†• Nuova</p>
                    <button type="button" class="btn btn-danger small-btn" onclick="removeEditFotoNuova(${idx})">ğŸ—‘ï¸ Rimuovi</button>
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    
    // Info sul numero di foto
    if (totaleFoto > 0) {
        html += `<p style="color:#666;font-size:14px;margin-top:10px">ğŸ“¸ ${totaleFoto}/3 foto</p>`;
    } else {
        html += `<p style="color:#999;font-size:14px;margin-top:10px">Nessuna foto. Click "â• Aggiungi Foto".</p>`;
    }
    
    container.innerHTML = html;
    
    // Abilita/disabilita pulsante aggiungi
    const btnAdd = document.getElementById('btnAddEditFoto');
    if (totaleFoto >= 3) {
        btnAdd.disabled = true;
        btnAdd.textContent = 'ğŸš« Max 3 foto';
    } else {
        btnAdd.disabled = false;
        btnAdd.textContent = 'â• Aggiungi Foto';
    }
}

// Aggiungi nuova foto nel modal edit
function addEditFoto() {
    const totaleFoto = editFotoEsistenti.length + editFotoNuove.length;
    if (totaleFoto >= 3) {
        alert('âš ï¸ Massimo 3 foto per giornale!');
        return;
    }
    
    // Crea input file nascosto
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = 'image/*';
    
    input.onchange = async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        try {
            // Comprimi immagine
            const compressed = await compImg(file);
            
            // Crea preview
            const reader = new FileReader();
            reader.onload = (e) => {
                editFotoNuove.push({
                    file: compressed,
                    preview: e.target.result
                });
                renderEditFoto();
            };
            reader.readAsDataURL(compressed);
            
        } catch (e) {
            console.error('Errore nella compressione:', e);
            alert('âŒ Errore nel caricamento della foto');
        }
    };
    
    input.click();
}

// Rimuovi foto esistente (marca per eliminazione)
function removeEditFotoEsistente(idx) {
    if (!confirm('Vuoi eliminare questa foto?\n\nL\'eliminazione sarÃ  effettiva al salvataggio.')) return;
    
    const foto = editFotoEsistenti[idx];
    // Salvo l'URL per trovare il file dopo
    editFotoEliminate.push(foto.url);
    editFotoEsistenti.splice(idx, 1);
    renderEditFoto();
}

// Rimuovi foto nuova (non ancora caricata)
function removeEditFotoNuova(idx) {
    editFotoNuove.splice(idx, 1);
    renderEditFoto();
}

// Aggiungi archeologo nel modal edit
function addEditArch() {
    editArcheologi.push({ nome: '', ore: 8 });
    renderEditArch();
}

// Rimuovi archeologo nel modal edit
function rmEditArch(idx) {
    editArcheologi.splice(idx, 1);
    renderEditArch();
}

// Renderizza archeologi nel modal edit
function renderEditArch() {
    const container = document.getElementById('editArcheologi');
    let html = '';
    
    editArcheologi.forEach((a, idx) => {
        html += `
            <div style="display:flex;gap:10px;margin-bottom:10px;align-items:center">
                <input type="text" placeholder="Nome Cognome" value="${a.nome || ''}" 
                       onchange="editArcheologi[${idx}].nome = this.value; updateEditArchCampoSelect()" 
                       style="flex:2">
                <input type="number" placeholder="Ore" value="${a.ore || 8}" min="0" step="0.5"
                       onchange="editArcheologi[${idx}].ore = parseFloat(this.value)" 
                       style="flex:1">
                <button type="button" class="btn btn-danger small-btn" onclick="rmEditArch(${idx})">ğŸ—‘ï¸</button>
            </div>
        `;
    });
    
    if (editArcheologi.length === 0) {
        html = '<p style="color:#999;font-size:14px">Nessun archeologo. Click "â• Aggiungi" per aggiungerne.</p>';
    }
    
    container.innerHTML = html;
    updateEditArchCampoSelect();
}

// Aggiorna dropdown Archeologo sul Campo nel modal edit
function updateEditArchCampoSelect() {
    const select = document.getElementById('editArchCampo');
    if (!select) return;
    
    const currentValue = select.value;
    
    // Ottieni lista archeologi correnti
    const archeologi = editArcheologi.filter(a => a.nome && a.nome.trim()).map(a => a.nome);
    
    // Ricostruisci select
    select.innerHTML = '<option value="">Seleziona archeologo...</option>';
    archeologi.forEach(arch => {
        const opt = document.createElement('option');
        opt.value = arch;
        opt.textContent = arch;
        select.appendChild(opt);
    });
    
    // Ripristina valore se presente
    if (currentValue && archeologi.includes(currentValue)) {
        select.value = currentValue;
    }
}

// Aggiungi operaio nel modal edit
function addEditOp() {
    editOperai.push({ nome: '', ore: 8 });
    renderEditOp();
}

// Rimuovi operaio nel modal edit
function rmEditOp(idx) {
    editOperai.splice(idx, 1);
    renderEditOp();
}

// Renderizza operai nel modal edit
function renderEditOp() {
    const container = document.getElementById('editOperai');
    let html = '';
    
    editOperai.forEach((o, idx) => {
        html += `
            <div style="display:flex;gap:10px;margin-bottom:10px;align-items:center">
                <input type="text" placeholder="Nome Cognome" value="${o.nome || ''}" 
                       onchange="editOperai[${idx}].nome = this.value" 
                       style="flex:2">
                <input type="number" placeholder="Ore" value="${o.ore || 8}" min="0" step="0.5"
                       onchange="editOperai[${idx}].ore = parseFloat(this.value)" 
                       style="flex:1">
                <button type="button" class="btn btn-danger small-btn" onclick="rmEditOp(${idx})">ğŸ—‘ï¸</button>
            </div>
        `;
    });
    
    if (editOperai.length === 0) {
        html = '<p style="color:#999;font-size:14px">Nessun operaio. Click "â• Aggiungi" per aggiungerne.</p>';
    }
    
    container.innerHTML = html;
}

// Chiudi modal modifica
function closeEditGiornale() {
    document.getElementById('modalEditGiornale').style.display = 'none';
    editingGiornaleId = null;
    editArcheologi = [];
    editOperai = [];
    editFotoEsistenti = [];
    editFotoNuove = [];
    editFotoEliminate = [];
}

// Salva modifiche giornale
async function saveEditGiornale() {
    const localita = document.getElementById('editLocalita').value.trim();
    const cantiereId = parseInt(document.getElementById('editCantiere').value);
    const data = document.getElementById('editData').value;
    const meteo = document.getElementById('editMeteo').value;
    const agibilita = document.getElementById('editAgibilita').value;
    const lavori = document.getElementById('editLavori').value.trim();
    
    // Trova il cantiere selezionato per prendere il codice sito e ResponsabileEnte
    const cantiereSelezionato = cantieriData.find(c => c.id == cantiereId);
    const codiceSito = cantiereSelezionato?.codiceSito || '';
    const respEnte = cantiereSelezionato?.responsabileEnte || '';
    
    const archCampo = document.getElementById('editArchCampo').value;
    const respAkhet = document.getElementById('editRespAkhet').value;
    
    // Leggi dati punto mappa
    const editPuntoNome = document.getElementById('editPuntoNome').value.trim();
    const editPuntoData = editPuntoCoords ? {
        nome: editPuntoNome || 'Punto senza nome',
        lat: editPuntoCoords.lat,
        lng: editPuntoCoords.lng,
        cantiere: cantiereSelezionato?.title || ''
    } : null;
    
    if (!localita || !cantiereId || !data || !meteo || !agibilita || !lavori) {
        alert('âš ï¸ Compila tutti i campi obbligatori!');
        return;
    }
    
    // Filtra archeologi e operai vuoti
    const archeologiFiltrati = editArcheologi.filter(a => a.nome && a.nome.trim());
    const operaiFiltrati = editOperai.filter(o => o.nome && o.nome.trim());
    
    const btnSave = document.getElementById('btnSaveEdit');
    btnSave.disabled = true;
    btnSave.textContent = 'â³ Salvataggio...';
    
    try {
        // ID lista Cantieri
        // 1. Aggiorna i campi BASE del giornale (sempre presenti)
        // NOTA: Il cantiere NON puÃ² essere modificato via API (problema SharePoint Lookup)
        const bodyFieldsBase = {
            Title: localita,
            CodiceSito: codiceSito || '',
            PuntoMappa: editPuntoData ? JSON.stringify(editPuntoData) : '',
            // CantiereLookupId rimosso - non modificabile via PATCH
            DataGiornale: data,
            CondMeteo: meteo,
            Agibilita: agibilita,
            Archeologi: JSON.stringify(archeologiFiltrati),
            Operai: JSON.stringify(operaiFiltrati),
            Lavori: lavori
        };
        
        console.log('ğŸ“¦ Modifica giornale (senza cantiere)');
        
        const response = await fetch(
            `https://graph.microsoft.com/v1.0/sites/${siteId}/lists/${giornaliListId}/items/${editingGiornaleId}/fields`,
            {
                method: 'PATCH',
                headers: {
                    'Authorization': `Bearer ${accessToken}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(bodyFieldsBase)
            }
        );
        
        if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`Errore ${response.status}: ${errorText}`);
        }
        
        console.log(`âœï¸ Giornale ${editingGiornaleId} modificato (campi base)`);
        
        // 2. Prova a salvare i NUOVI campi (potrebbero non esistere nei giornali vecchi)
        if (respEnte || archCampo || respAkhet) {
            try {
                const bodyFieldsNew = {};
                if (respEnte) bodyFieldsNew.ResponsabileEnte = respEnte;
                if (archCampo) bodyFieldsNew.ArcheologoSulCampo = archCampo;
                if (respAkhet) bodyFieldsNew.ResponsabileAkhet = respAkhet;
                
                console.log('ğŸ“¦ Salvataggio campi aggiuntivi:', bodyFieldsNew);
                
                const response2 = await fetch(
                    `https://graph.microsoft.com/v1.0/sites/${siteId}/lists/${giornaliListId}/items/${editingGiornaleId}/fields`,
                    {
                        method: 'PATCH',
                        headers: {
                            'Authorization': `Bearer ${accessToken}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(bodyFieldsNew)
                    }
                );
                
                if (response2.ok) {
                    console.log(`âœï¸ Campi aggiuntivi salvati`);
                } else {
                    console.warn('âš ï¸ Campi aggiuntivi non salvati (potrebbero non esistere in SharePoint)');
                }
            } catch (e) {
                console.warn('âš ï¸ Impossibile salvare campi aggiuntivi:', e.message);
            }
        }
        
        console.log(`âœï¸ Giornale ${editingGiornaleId} modificato`);
        
        // 2. Gestione foto
        const driveId = await getDriveId();
        const folderId = await getFotoFolderId(driveId);
        
        // 2a. Elimina foto marchiate per eliminazione
        if (editFotoEliminate.length > 0) {
            btnSave.textContent = 'â³ Eliminazione foto...';
            
            // Carica tutti i file della cartella
            const searchResponse = await fetch(
                `https://graph.microsoft.com/v1.0/drives/${driveId}/items/${folderId}/children`,
                {
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                }
            );
            
            const searchData = await searchResponse.json();
            const prefix = `giornale_${editingGiornaleId}_`;
            
            // Per ogni URL da eliminare, trova il file corrispondente
            for (const url of editFotoEliminate) {
                try {
                    // Cerca il file che corrisponde a questo URL
                    const file = searchData.value.find(f => {
                        const downloadUrl = f['@microsoft.graph.downloadUrl'];
                        return downloadUrl === url || f.name.startsWith(prefix);
                    });
                    
                    if (file) {
                        await fetch(
                            `https://graph.microsoft.com/v1.0/drives/${driveId}/items/${file.id}`,
                            {
                                method: 'DELETE',
                                headers: { 'Authorization': `Bearer ${accessToken}` }
                            }
                        );
                        console.log(`ğŸ—‘ï¸ Foto eliminata: ${file.name}`);
                    }
                } catch (e) {
                    console.error(`Errore nell'eliminazione di foto:`, e);
                }
            }
        }
        
        // 2b. Upload nuove foto
        if (editFotoNuove.length > 0) {
            btnSave.textContent = 'â³ Upload foto...';
            for (let i = 0; i < editFotoNuove.length; i++) {
                const fotoObj = editFotoNuove[i];
                const timestamp = Date.now();
                const filename = `giornale_${editingGiornaleId}_${timestamp}_${i + 1}.jpg`;
                
                try {
                    const uploadResponse = await fetch(
                        `https://graph.microsoft.com/v1.0/drives/${driveId}/items/${folderId}:/${filename}:/content`,
                        {
                            method: 'PUT',
                            headers: {
                                'Authorization': `Bearer ${accessToken}`,
                                'Content-Type': 'image/jpeg'
                            },
                            body: fotoObj.file
                        }
                    );
                    
                    if (uploadResponse.ok) {
                        console.log(`ğŸ“¸ Foto caricata: ${filename}`);
                    }
                } catch (e) {
                    console.error(`Errore nell'upload di foto ${i + 1}:`, e);
                }
            }
        }
        
        // 3. Aggiorna dati locali
        const g = giornaliData.find(x => x.id == editingGiornaleId);
        if (g) {
            g.title = localita;
            g.codiceSito = codiceSito;
            g.cantiereId = cantiereId;
            g.cantiere = cantieriData.find(c => c.id == cantiereId)?.title || 'N/A';
            g.data = data;
            g.meteo = meteo;
            g.agibilita = agibilita;
            g.archeologi = archeologiFiltrati;
            g.operai = operaiFiltrati;
            g.lavori = lavori;
            g.puntoMappa = editPuntoData;
        }
        
        // Aggiorna anche filteredGiornali
        const filtG = filteredGiornali.find(x => x.id == editingGiornaleId);
        if (filtG) {
            filtG.title = localita;
            filtG.cantiereId = cantiereId;
            filtG.cantiere = cantieriData.find(c => c.id == cantiereId)?.title || 'N/A';
            filtG.data = data;
            filtG.meteo = meteo;
            filtG.agibilita = agibilita;
            filtG.archeologi = archeologiFiltrati;
            filtG.operai = operaiFiltrati;
            filtG.lavori = lavori;
        }
        
        // 4. Ricarica le foto per aggiornare la cache
        await loadAllFoto();
        
        closeEditGiornale();
        displayGiornali();
        
        alert('âœï¸ Giornale e foto modificati con successo!');
        
    } catch (e) {
        console.error('Errore nel salvataggio:', e);
        alert('âŒ Errore nel salvataggio: ' + e.message);
    } finally {
        btnSave.disabled = false;
        btnSave.textContent = 'ğŸ’¾ Salva Modifiche';
    }
}

// Elimina giornale
async function deleteGiornale(id) {
    const g = giornaliData.find(x => x.id == id);
    if (!g) return;
    
    if (!confirm(`Vuoi eliminare il giornale "${g.title}" del ${formatDate(g.data)}?\n\nQuesta azione Ã¨ irreversibile!`)) return;
    
    try {
        // Elimina giornale da SharePoint
        const response = await fetch(
            `https://graph.microsoft.com/v1.0/sites/${siteId}/lists/${giornaliListId}/items/${id}`,
            {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${accessToken}` }
            }
        );
        
        if (!response.ok) {
            throw new Error(`Errore ${response.status}`);
        }
        
        console.log(`ğŸ—‘ï¸ Giornale ${id} eliminato`);
        
        // Rimuovi dai dati locali
        giornaliData = giornaliData.filter(x => x.id != id);
        filteredGiornali = filteredGiornali.filter(x => x.id != id);
        
        // Ridisegna
        displayGiornali();
        
        // Aggiorna filtri
        populateFilters();
        
        alert('ğŸ—‘ï¸ Giornale eliminato con successo!');
        
    } catch (e) {
        console.error('Errore nell\'eliminazione:', e);
        alert('âŒ Errore nell\'eliminazione: ' + e.message);
    }
}

// === GESTIONE CANTIERI ===

// Apri modal cantiere (nuovo o modifica)
function openModalCantiere(id = null) {
    editingCantiereId = id;
    const modal = document.getElementById('modalCantiere');
    const titolo = document.getElementById('modalCantiereTitolo');
    
    // Gestione permessi per GeoJSON (solo Admin/Supervisor possono caricare, Operator puÃ² solo visualizzare)
    const uploadSection = document.getElementById('geoJsonUploadSection');
    
    // Mostra upload solo se NON Ã¨ Operator (o se currentUser non Ã¨ ancora caricato, mostra comunque)
    if (currentUser && currentUser.role === 'Operator') {
        uploadSection.style.display = 'none';
    } else {
        uploadSection.style.display = 'block';
    }
    
    const canUploadGeoJson = !currentUser || currentUser.role !== 'Operator';
    
    // Reset GeoJSON
    cantiereGeoJsonData = null;
    document.getElementById('mCantGeoJson').value = '';
    document.getElementById('geoJsonFileName').textContent = '';
    document.getElementById('btnRemoveGeoJson').style.display = 'none';
    if (cantiereGeoJsonLayer && cantiereMap) {
        cantiereMap.removeLayer(cantiereGeoJsonLayer);
        cantiereGeoJsonLayer = null;
    }
    
    if (id) {
        // Modifica
        const cant = cantieriData.find(c => c.id == id);
        if (!cant) return;
        
        titolo.textContent = 'âœï¸ Modifica Cantiere';
        document.getElementById('mCantNome').value = cant.title;
        document.getElementById('mCantComm').value = cant.committente;
        document.getElementById('mCantProg').value = cant.codiceProgetto;
        document.getElementById('mCantComessa').value = cant.codiceCommessa;
        document.getElementById('mCantSito').value = cant.codiceSito || '';
        document.getElementById('mCantRespEnte').value = cant.responsabileEnte || '';
        
        // Carica GeoJSON esistente se presente
        if (cant.geoJson) {
            try {
                cantiereGeoJsonData = JSON.parse(cant.geoJson);
                setTimeout(() => {
                    if (!cantiereMap) initCantiereMap();
                    displayGeoJsonOnMap(cantiereGeoJsonData);
                    document.getElementById('geoJsonFileName').textContent = 'âœ… GeoJSON giÃ  presente';
                    if (canUploadGeoJson) {
                        document.getElementById('btnRemoveGeoJson').style.display = 'inline-block';
                    }
                }, 200);
            } catch(e) {
                console.warn('Errore caricamento GeoJSON esistente:', e);
            }
        }
    } else {
        // Nuovo
        titolo.textContent = 'â• Nuovo Cantiere';
        document.getElementById('mCantNome').value = '';
        document.getElementById('mCantComm').value = '';
        document.getElementById('mCantProg').value = '';
        document.getElementById('mCantComessa').value = '';
        document.getElementById('mCantSito').value = '';
        document.getElementById('mCantRespEnte').value = '';
    }
    
    // Inizializza mappa
    setTimeout(() => {
        if (!cantiereMap) {
            initCantiereMap();
        } else {
            cantiereMap.invalidateSize();
        }
    }, 100);
    
    modal.style.display = 'flex';
}

// Chiudi modal cantiere
function closeModalCantiere() {
    document.getElementById('modalCantiere').style.display = 'none';
    editingCantiereId = null;
}

// Salva cantiere (nuovo o modifica)
async function saveCantiere() {
    const nome = document.getElementById('mCantNome').value.trim();
    const comm = document.getElementById('mCantComm').value.trim();
    const prog = document.getElementById('mCantProg').value.trim();
    const comessa = document.getElementById('mCantComessa').value.trim();
    const sito = document.getElementById('mCantSito').value.trim();
    const respEnte = document.getElementById('mCantRespEnte').value.trim();
    
    if (!nome || !comm || !prog || !comessa) {
        alert('âš ï¸ Compila tutti i campi!');
        return;
    }
    
    const btnSave = document.getElementById('btnSaveCant');
    btnSave.disabled = true;
    btnSave.textContent = 'â³ Salvataggio...';
    
    try {
        if (editingCantiereId) {
            // ========== MODIFICA ==========
            // 1. Salva campi base (sempre presenti)
            const bodyBase = {
                Title: nome,
                Committente: comm
            };
            
            const response = await fetch(
                `https://graph.microsoft.com/v1.0/sites/${siteId}/lists/${cantieriListId}/items/${editingCantiereId}/fields`,
                {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(bodyBase)
                }
            );
            
            if (!response.ok) {
                const errorText = await response.text();
                console.error('Errore completo:', errorText);
                throw new Error(`Errore ${response.status}: ${errorText}`);
            }
            
            console.log(`âœï¸ Cantiere ${editingCantiereId} modificato (campi base)`);
            
            // 2. Prova a salvare i codici (opzionali)
            try {
                const bodyCodici = {
                    CodProg: prog,
                    CodComm: comessa,
                    CodiceSito: sito || '',
                    ResponsabileEnte: respEnte || '',
                    GeoJson: cantiereGeoJsonData ? JSON.stringify(cantiereGeoJsonData) : ''
                };
                
                const response2 = await fetch(
                    `https://graph.microsoft.com/v1.0/sites/${siteId}/lists/${cantieriListId}/items/${editingCantiereId}/fields`,
                    {
                        method: 'PATCH',
                        headers: {
                            'Authorization': `Bearer ${accessToken}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(bodyCodici)
                    }
                );
                
                if (response2.ok) {
                    console.log(`âœï¸ Codici salvati`);
                } else {
                    console.warn('âš ï¸ Codici non salvati (rinomina campi in SharePoint come da istruzioni)');
                }
            } catch (e) {
                console.warn('âš ï¸ Impossibile salvare codici:', e.message);
            }
            
            // Aggiorna dati locali
            const cant = cantieriData.find(c => c.id == editingCantiereId);
            if (cant) {
                cant.title = nome;
                cant.committente = comm;
                cant.codiceProgetto = prog;
                cant.codiceCommessa = comessa;
                cant.codiceSito = sito;
                cant.responsabileEnte = respEnte;
                cant.geoJson = cantiereGeoJsonData ? JSON.stringify(cantiereGeoJsonData) : '';
            }
            
            alert('âœï¸ Cantiere modificato con successo!');
            
        } else {
            // ========== CREAZIONE ==========
            // 1. Crea con campi base
            const bodyBase = {
                fields: {
                    Title: nome,
                    Committente: comm
                }
            };
            
            console.log('Creazione cantiere con dati base:', bodyBase);
            
            const response = await fetch(
                `https://graph.microsoft.com/v1.0/sites/${siteId}/lists/${cantieriListId}/items`,
                {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(bodyBase)
                }
            );
            
            if (!response.ok) {
                const errorText = await response.text();
                console.error('Errore completo:', errorText);
                throw new Error(`Errore ${response.status}: ${errorText}`);
            }
            
            const created = await response.json();
            console.log(`â• Cantiere ${created.id} creato (campi base)`);
            
            // 2. Prova ad aggiungere i codici
            try {
                const bodyCodici = {
                    CodProg: prog,
                    CodComm: comessa,
                    CodiceSito: sito || '',
                    ResponsabileEnte: respEnte || '',
                    GeoJson: cantiereGeoJsonData ? JSON.stringify(cantiereGeoJsonData) : ''
                };
                
                const response2 = await fetch(
                    `https://graph.microsoft.com/v1.0/sites/${siteId}/lists/${cantieriListId}/items/${created.id}/fields`,
                    {
                        method: 'PATCH',
                        headers: {
                            'Authorization': `Bearer ${accessToken}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(bodyCodici)
                    }
                );
                
                if (response2.ok) {
                    console.log(`âœï¸ Codici aggiunti al nuovo cantiere`);
                } else {
                    console.warn('âš ï¸ Codici non salvati (rinomina campi in SharePoint come da istruzioni)');
                }
            } catch (e) {
                console.warn('âš ï¸ Impossibile salvare codici:', e.message);
            }
            
            // Ricarica cantieri
            await loadCantieri();
            
            // Aggiorna select nel form giornali
            popCant();
            
            // Aggiorna filtri
            populateFilters();
            
            alert('â• Cantiere creato con successo!');
        }
        
        closeModalCantiere();
        displayCantieri();
        
    } catch (e) {
        console.error('Errore nel salvataggio:', e);
        alert('âŒ Errore: ' + e.message);
    } finally {
        btnSave.disabled = false;
        btnSave.textContent = 'ğŸ’¾ Salva';
    }
}

// Modifica cantiere
// Visualizza cantiere (sola lettura)
function viewCantiere(id) {
    const cant = cantieriData.find(c => c.id == id);
    if (!cant) return;
    
    // Popola dati
    document.getElementById('viewCantNome').textContent = cant.title;
    document.getElementById('viewCantComm').textContent = cant.committente;
    document.getElementById('viewCantProg').textContent = cant.codiceProgetto;
    document.getElementById('viewCantComessa').textContent = cant.codiceCommessa;
    document.getElementById('viewCantSito').textContent = cant.codiceSito || 'Non specificato';
    document.getElementById('viewCantRespEnte').textContent = cant.responsabileEnte || 'Non specificato';
    
    // Inizializza mappa visualizzazione
    setTimeout(() => {
        if (!viewCantiereMap) {
            viewCantiereMap = L.map('viewCantiereMap').setView([45.7, 7.3], 10);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(viewCantiereMap);
        } else {
            viewCantiereMap.invalidateSize();
        }
        
        // Carica GeoJSON se presente
        if (cant.geoJson) {
            try {
                const geoJsonData = JSON.parse(cant.geoJson);
                
                // Rimuovi layer precedente
                if (viewCantiereGeoJsonLayer) {
                    viewCantiereMap.removeLayer(viewCantiereGeoJsonLayer);
                }
                
                // Aggiungi layer GeoJSON
                viewCantiereGeoJsonLayer = L.geoJSON(geoJsonData, {
                    style: function(feature) {
                        return {
                            color: '#3498db',
                            weight: 3,
                            opacity: 0.8,
                            fillColor: '#3498db',
                            fillOpacity: 0.3
                        };
                    },
                    pointToLayer: function(feature, latlng) {
                        return L.circleMarker(latlng, {
                            radius: 8,
                            fillColor: '#e74c3c',
                            color: '#c0392b',
                            weight: 2,
                            opacity: 1,
                            fillOpacity: 0.8
                        });
                    },
                    onEachFeature: function(feature, layer) {
                        if (feature.properties) {
                            let popupContent = '<div style="max-width:200px">';
                            for (let key in feature.properties) {
                                popupContent += `<strong>${key}:</strong> ${feature.properties[key]}<br>`;
                            }
                            popupContent += '</div>';
                            layer.bindPopup(popupContent);
                        }
                    }
                }).addTo(viewCantiereMap);
                
                // Centra mappa sui dati
                try {
                    viewCantiereMap.fitBounds(viewCantiereGeoJsonLayer.getBounds(), { padding: [20, 20] });
                } catch(e) {
                    console.warn('Impossibile centrare mappa:', e);
                }
                
                document.getElementById('viewGeoJsonStatus').textContent = 'âœ… Mappa progetto caricata';
                document.getElementById('viewGeoJsonStatus').style.color = '#27ae60';
                
            } catch(e) {
                console.error('Errore caricamento GeoJSON:', e);
                document.getElementById('viewGeoJsonStatus').textContent = 'âš ï¸ Errore nel caricamento della mappa';
                document.getElementById('viewGeoJsonStatus').style.color = '#e74c3c';
            }
        } else {
            document.getElementById('viewGeoJsonStatus').textContent = 'â„¹ï¸ Nessuna mappa disponibile per questo cantiere';
            document.getElementById('viewGeoJsonStatus').style.color = '#95a5a6';
            
            // Rimuovi layer se esiste
            if (viewCantiereGeoJsonLayer) {
                viewCantiereMap.removeLayer(viewCantiereGeoJsonLayer);
                viewCantiereGeoJsonLayer = null;
            }
            
            viewCantiereMap.setView([45.7, 7.3], 10);
        }
    }, 200);
    
    // Mostra modal
    document.getElementById('modalViewCantiere').style.display = 'flex';
}

function closeViewCantiere() {
    document.getElementById('modalViewCantiere').style.display = 'none';
}

// Modifica cantiere
function editCantiere(id) {
    openModalCantiere(id);
}

// Elimina cantiere
async function deleteCantiere(id) {
    const cant = cantieriData.find(c => c.id == id);
    if (!cant) return;
    
    // Verifica se ci sono giornali associati
    const giornaliAssociati = giornaliData.filter(g => g.cantiereId == id);
    if (giornaliAssociati.length > 0) {
        alert(`âš ï¸ Impossibile eliminare!\n\nCi sono ${giornaliAssociati.length} giornali associati a questo cantiere.\n\nElimina prima i giornali.`);
        return;
    }
    
    if (!confirm(`Vuoi eliminare il cantiere "${cant.title}"?\n\nQuesta azione Ã¨ irreversibile!`)) return;
    
    try {
        const response = await fetch(
            `https://graph.microsoft.com/v1.0/sites/${siteId}/lists/${cantieriListId}/items/${id}`,
            {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${accessToken}` }
            }
        );
        
        if (!response.ok) {
            throw new Error(`Errore ${response.status}`);
        }
        
        console.log(`ğŸ—‘ï¸ Cantiere ${id} eliminato`);
        
        // Rimuovi dai dati locali
        cantieriData = cantieriData.filter(c => c.id != id);
        
        // Ridisegna
        displayCantieri();
        
        // Aggiorna select e filtri
        popCant();
        populateFilters();
        
        alert('ğŸ—‘ï¸ Cantiere eliminato con successo!');
        
    } catch (e) {
        console.error('Errore nell\'eliminazione:', e);
        alert('âŒ Errore: ' + e.message);
    }
}

console.log("âœ… FASE C COMPLETATA!");

// ============================================
// GESTIONE UTENTI E RUOLI
// ============================================

// Ottieni ID lista Utenti
async function getUserListId() {
    try {
        const response = await fetch(
            `https://graph.microsoft.com/v1.0/sites/${siteId}/lists?$filter=displayName eq 'Utenti'`,
            {
                headers: { 'Authorization': `Bearer ${accessToken}` }
            }
        );
        
        const data = await response.json();
        if (data.value.length > 0) {
            utentiListId = data.value[0].id;
            console.log('ğŸ“‹ Lista Utenti ID:', utentiListId);
            return true;
        } else {
            console.warn('âš ï¸ Lista "Utenti" non trovata in SharePoint');
            return false;
        }
    } catch (e) {
        console.error('Errore nel caricamento lista Utenti:', e);
        return false;
    }
}

// Rileva ruolo utente corrente
async function loadCurrentUserRole() {
    try {
        if (!utentiListId) {
            console.warn('âš ï¸ Lista Utenti non disponibile, ruolo default: operator');
            currentUserRole = 'operator';
            document.getElementById('userRole').textContent = 'ğŸ‘¤ Operator (Default)';
            return;
        }
        
        // Carica TUTTI gli utenti e cerca lato client
        const email = currentUser.username.toLowerCase();
        const response = await fetch(
            `https://graph.microsoft.com/v1.0/sites/${siteId}/lists/${utentiListId}/items?$expand=fields`,
            {
                headers: { 'Authorization': `Bearer ${accessToken}` }
            }
        );
        
        if (!response.ok) {
            throw new Error(`Errore ${response.status}`);
        }
        
        const data = await response.json();
        
        // Cerca l'utente confrontando le email (case-insensitive)
        const userItem = data.value.find(item => 
            item.fields.Title && item.fields.Title.toLowerCase() === email
        );
        
        if (userItem) {
            const fields = userItem.fields;
            currentUserRole = (fields.Ruolo || 'operator').toLowerCase();
            
            const roleIcons = {
                'admin': 'ğŸ‘‘ Admin',
                'supervisor': 'âœ… Supervisor',
                'operator': 'ğŸ‘¤ Operator'
            };
            
            document.getElementById('userRole').textContent = roleIcons[currentUserRole] || 'ğŸ‘¤ Operator';
            console.log(`ğŸ” Ruolo utente: ${currentUserRole.toUpperCase()}`);
            
            // Salva cantieri assegnati se operator
            if (currentUserRole === 'operator' && fields.CantieriAssegnati) {
                const cantieriIds = fields.CantieriAssegnati.split(',').map(id => parseInt(id.trim()));
                console.log(`ğŸ‘¤ Operator - Cantieri assegnati:`, cantieriIds);
            }
            
        } else {
            console.warn(`âš ï¸ Utente ${email} non trovato nella lista Utenti`);
            currentUserRole = 'operator';
            document.getElementById('userRole').textContent = 'ğŸ‘¤ Operator (Non in lista)';
        }
        
    } catch (e) {
        console.error('Errore nel caricamento ruolo:', e);
        currentUserRole = 'operator';
        document.getElementById('userRole').textContent = 'ğŸ‘¤ Operator (Errore)';
    }
}

// Carica lista utenti
async function loadUtenti() {
    try {
        if (!utentiListId) {
            document.getElementById('utentiContent').innerHTML = 
                '<div class="info">âš ï¸ Lista "Utenti" non trovata in SharePoint. <a href="/mnt/user-data/outputs/ISTRUZIONI_LISTA_UTENTI.md" target="_blank">Vedi istruzioni</a></div>';
            return;
        }
        
        const response = await fetch(
            `https://graph.microsoft.com/v1.0/sites/${siteId}/lists/${utentiListId}/items?$expand=fields`,
            {
                headers: { 'Authorization': `Bearer ${accessToken}` }
            }
        );
        
        const data = await response.json();
        
        utentiData = data.value.map(item => {
            // DEBUG: Log del primo utente per vedere la struttura completa
            if (utentiData.length === 0) {
                console.log('ğŸ“‹ DEBUG - Primo utente completo:', item.fields);
                console.log('ğŸ“‹ DEBUG - CantieriAssegnati raw:', item.fields.CantieriAssegnati);
            }
            
            // Gestisci il campo CantieriAssegnati che potrebbe essere:
            // - Una stringa con ID separati da virgola: "1,2,3"
            // - Un array di oggetti Lookup: [{LookupId: 1}, {LookupId: 2}]
            // - Un array di ID: [1, 2, 3]
            let cantieriAssegnati = '';
            
            if (item.fields.CantieriAssegnati) {
                if (Array.isArray(item.fields.CantieriAssegnati)) {
                    // Ãˆ un array - potrebbe essere di oggetti Lookup o di ID
                    cantieriAssegnati = item.fields.CantieriAssegnati
                        .map(c => c.LookupId || c)
                        .join(',');
                } else if (typeof item.fields.CantieriAssegnati === 'string') {
                    // Ãˆ giÃ  una stringa
                    cantieriAssegnati = item.fields.CantieriAssegnati;
                } else if (typeof item.fields.CantieriAssegnati === 'object') {
                    // Ãˆ un singolo oggetto Lookup
                    cantieriAssegnati = String(item.fields.CantieriAssegnati.LookupId || '');
                }
            }
            
            return {
                id: item.id,
                email: item.fields.Title,
                nome: item.fields.Nome || 'N/A',
                ruolo: (item.fields.Ruolo || 'operator').toLowerCase(),
                cantieriAssegnati: cantieriAssegnati
            };
        });
        
        console.log(`ğŸ‘¥ Caricati ${utentiData.length} utenti`);
        displayUtenti();
        
    } catch (e) {
        console.error('Errore nel caricamento utenti:', e);
        document.getElementById('utentiContent').innerHTML = 
            '<div class="error">âŒ Errore nel caricamento utenti</div>';
    }
}

// Visualizza lista utenti
function displayUtenti() {
    const container = document.getElementById('utentiContent');
    
    // Solo admin puÃ² gestire utenti
    if (currentUserRole !== 'admin') {
        container.innerHTML = '<div class="info">âš ï¸ Solo gli Admin possono gestire gli utenti</div>';
        return;
    }
    
    if (utentiData.length === 0) {
        container.innerHTML = `
            <div class="info">ğŸ‘¥ Nessun utente nella lista</div>
            <p style="margin-top:10px">Aggiungi utenti manualmente in SharePoint nella lista "Utenti".</p>
        `;
        return;
    }
    
    let html = '<div style="display:grid;gap:15px">';
    
    utentiData.forEach(user => {
        const roleIcon = {
            'admin': 'ğŸ‘‘',
            'supervisor': 'âœ…',
            'operator': 'ğŸ‘¤'
        }[user.ruolo] || 'ğŸ‘¤';
        
        const roleColor = {
            'admin': '#e74c3c',
            'supervisor': '#f39c12',
            'operator': '#3498db'
        }[user.ruolo] || '#3498db';
        
        const cantieri = user.cantieriAssegnati ? 
            user.cantieriAssegnati.split(',').filter(x => x.trim()).length : 0;
        
        html += `
            <div class="card">
                <h4>${roleIcon} ${user.nome}</h4>
                <p><strong>Email:</strong> ${user.email}</p>
                <p><strong>Ruolo:</strong> <span style="color:${roleColor};font-weight:600;text-transform:uppercase">${user.ruolo}</span></p>
                <p><strong>Cantieri assegnati:</strong> ${cantieri > 0 ? cantieri + ' cantieri' : 'Tutti (nessun limite)'}</p>
                <div style="margin-top:15px">
                    <button class="btn btn-warning small-btn" onclick="editUtente(${user.id})">âœï¸ Modifica Ruolo</button>
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    container.innerHTML = html;
}

// Apri modal modifica utente
function editUtente(id) {
    const user = utentiData.find(u => u.id == id);
    if (!user) return;
    
    editingUserId = id;
    
    document.getElementById('mUserName').value = user.nome;
    document.getElementById('mUserEmail').value = user.email;
    document.getElementById('mUserRole').value = user.ruolo;
    
    // Popola checkboxes cantieri
    const container = document.getElementById('mUserCantieri');
    const cantieriIds = user.cantieriAssegnati ? 
        user.cantieriAssegnati.split(',').map(id => id.trim()) : [];
    
    let html = '<p style="margin-bottom:10px;color:#666;font-size:14px">Seleziona i cantieri (solo per Operator):</p>';
    
    if (cantieriData.length === 0) {
        html += '<p style="color:#999">Nessun cantiere disponibile</p>';
    } else {
        cantieriData.forEach(cant => {
            const checked = cantieriIds.includes(String(cant.id)) ? 'checked' : '';
            html += `
                <label style="display:block;margin:8px 0;cursor:pointer">
                    <input type="checkbox" value="${cant.id}" ${checked} style="margin-right:8px">
                    ${cant.title}
                </label>
            `;
        });
    }
    
    container.innerHTML = html;
    
    document.getElementById('modalUtente').style.display = 'flex';
}

// Chiudi modal utente
function closeModalUtente() {
    document.getElementById('modalUtente').style.display = 'none';
    editingUserId = null;
}

// Salva modifiche utente
async function saveUtente() {
    const ruolo = document.getElementById('mUserRole').value;
    
    // Raccogli cantieri selezionati
    const checkboxes = document.querySelectorAll('#mUserCantieri input[type="checkbox"]:checked');
    const cantieriIds = Array.from(checkboxes).map(cb => cb.value).join(',');
    
    const btnSave = document.getElementById('btnSaveUser');
    btnSave.disabled = true;
    btnSave.textContent = 'â³ Salvataggio...';
    
    try {
        const response = await fetch(
            `https://graph.microsoft.com/v1.0/sites/${siteId}/lists/${utentiListId}/items/${editingUserId}/fields`,
            {
                method: 'PATCH',
                headers: {
                    'Authorization': `Bearer ${accessToken}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    Ruolo: ruolo.charAt(0).toUpperCase() + ruolo.slice(1),
                    CantieriAssegnati: cantieriIds
                })
            }
        );
        
        if (!response.ok) throw new Error(`Errore ${response.status}`);
        
        console.log(`âœï¸ Utente ${editingUserId} aggiornato: ruolo=${ruolo}, cantieri=${cantieriIds}`);
        
        // Aggiorna dati locali
        const user = utentiData.find(u => u.id == editingUserId);
        if (user) {
            user.ruolo = ruolo;
            user.cantieriAssegnati = cantieriIds;
        }
        
        closeModalUtente();
        displayUtenti();
        
        alert('âœ… Utente aggiornato con successo!');
        
    } catch (e) {
        console.error('Errore nel salvataggio:', e);
        alert('âŒ Errore: ' + e.message);
    } finally {
        btnSave.disabled = false;
        btnSave.textContent = 'ğŸ’¾ Salva';
    }
}

console.log("âœ… GESTIONE UTENTI IMPLEMENTATA!");

console.log("ğŸ“‹ FunzionalitÃ  complete:");
console.log("  - Login Microsoft 365");
console.log("  - Visualizza cantieri/giornali");
console.log("  - Crea giornali + upload foto");
console.log("  - Visualizza foto con lightbox");
console.log("  - Filtri avanzati (cantiere, mese, giorno, stato)");
console.log("  - Validazione giornali");
console.log("  - Export PDF professionale");
console.log("  - Elimina giornali");
console.log("  - Gestione cantieri CRUD");
console.log("  - ğŸ‘¥ Gestione utenti e ruoli");
console.log("  - ğŸ” Controllo accessi basato su ruoli");
console.log("  - ğŸ“Š Dashboard personalizzata per ruolo");
console.log("  - ğŸ—ºï¸ Mappa OpenStreetMap per punti di interesse");
console.log("ğŸ‰ APPLICAZIONE COMPLETA CON GESTIONE UTENTI!");

// Inizializza mappa quando il DOM Ã¨ pronto
setTimeout(() => {
    if (document.getElementById('map')) {
        try {
            initMap();
            console.log('ğŸ—ºï¸ Mappa inizializzata');
            
            // Ridimensionamenti aggiuntivi per assicurare il corretto rendering
            setTimeout(() => {
                if (map) {
                    map.invalidateSize();
                    console.log('ğŸ—ºï¸ Primo ridimensionamento post-init');
                }
            }, 500);
            
            setTimeout(() => {
                if (map) {
                    map.invalidateSize();
                    console.log('ğŸ—ºï¸ Secondo ridimensionamento post-init');
                }
            }, 1500);
        } catch(e) {
            console.warn('Errore inizializzazione mappa:', e);
        }
    }
}, 1200);

</script>

</body>
</html>
